<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®çºªè¦ç³»ç»Ÿ - ç»Ÿä¸€é—¨æˆ·ç³»ç»Ÿ</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            font-size: 16px; /* å¢åŠ åŸºç¡€å­—ä½“å¤§å° */
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px; /* å¢å¤§æ ‡é¢˜å­—ä½“ */
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: 18px; /* å¢å¤§å‰¯æ ‡é¢˜å­—ä½“ */
            opacity: 0.9;
        }

        /* æ–°çš„æµç¨‹å¼å¸ƒå±€ */
        .workflow-container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .workflow-step {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .workflow-step:hover {
            border-color: #007bff;
            box-shadow: 0 4px 16px rgba(0,123,255,0.1);
        }

        .step-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 20px; /* å¢å¤§æ­¥éª¤æ ‡é¢˜å­—ä½“ */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: rgba(255,255,255,0.2);
            width: 32px; /* å¢å¤§æ­¥éª¤ç¼–å·åœ†åœˆ */
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px; /* å¢å¤§æ­¥éª¤ç¼–å·å­—ä½“ */
        }

        .step-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .step-main {
            flex: 2;
        }

        .step-controls {
            flex: 1;
            min-width: 300px;
        }

        /* éŸ³é¢‘ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #fafafa, #f0f0f0);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: linear-gradient(135deg, #e6f3ff, #cce7ff);
        }

        .upload-icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #333;
            font-size: 20px; /* å¢å¤§ä¸Šä¼ æ–‡æœ¬å­—ä½“ */
            font-weight: 500;
            margin-bottom: 10px;
        }

        .file-info {
            color: #666;
            font-size: 16px; /* å¢å¤§æ–‡ä»¶ä¿¡æ¯å­—ä½“ */
            line-height: 1.5;
        }

        .file-input {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px; /* å¢å¤§æˆåŠŸæ¶ˆæ¯å­—ä½“ */
            display: none;
            border-left: 4px solid #28a745;
        }

        /* éŸ³é¢‘å¤„ç†åŒºåŸŸä¼˜åŒ– */
        .processing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-group label {
            font-size: 18px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .option-group input, .option-group select {
            padding: 12px 14px; /* å¢å¤§è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .option-group input:focus, .option-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            height: 50px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 18px; /* å¢å¤§è¿›åº¦æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 8px;
            text-align: center;
            font-weight: 500;
        }

        /* ASRä¼˜åŒ–é¢æ¿ä¼˜åŒ– */
        .asr-optimization-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #007bff;
            border-radius: 12px;
            border-left: 6px solid #007bff;
        }

        .optimization-header {
            font-size: 20px; /* å¢å¤§ä¼˜åŒ–æ ‡é¢˜å­—ä½“ */
            font-weight: 600;
            color: #007bff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .optimization-options {
            display: grid;
            gap: 15px;
        }

        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .option-row:last-child {
            border-bottom: none;
        }

        .option-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px; /* å¢å¤§é€‰é¡¹æ ‡ç­¾å­—ä½“ */
            color: #333;
            cursor: pointer;
            min-width: 200px;
            font-weight: 500;
        }

        .option-row input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .option-row select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 150px;
        }

        .option-desc {
            font-size: 16px; /* å¢å¤§é€‰é¡¹æè¿°å­—ä½“ */
            color: #666;
            font-style: italic;
            flex: 1;
            text-align: right;
        }

        .help-text {
            font-size: 16px; /* å¢å¤§å¸®åŠ©æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* éŸ³é¢‘æ‹¼æ¥åŒºåŸŸä¼˜åŒ– */
        .splice-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥ä¿¡æ¯å­—ä½“ */
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .splice-files-container {
            margin-bottom: 20px;
        }

        .splice-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .splice-files-header h4 {
            margin: 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥æ–‡ä»¶æ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        .splice-files-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            min-height: 120px;
            padding: 15px;
            background-color: #fafafa;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-size: 18px; /* å¢å¤§ç©ºæ¶ˆæ¯å­—ä½“ */
            padding: 30px;
        }

        .splice-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 18px; /* å¢å¤§å†…è¾¹è· */
            margin-bottom: 8px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹å­—ä½“ */
            transition: all 0.3s ease;
        }

        .splice-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }

        .splice-item:last-child {
            margin-bottom: 0;
        }

        .splice-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .splice-item-name {
            font-weight: 600;
            color: #333;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹åç§°å­—ä½“ */
        }

        .splice-item-duration {
            color: #666;
            font-size: 16px; /* å¢å¤§æ‹¼æ¥é¡¹æ—¶é•¿å­—ä½“ */
        }

        .splice-item-controls {
            display: flex;
            gap: 8px;
        }

        .splice-item-controls button {
            padding: 8px 14px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§æŒ‰é’®å­—ä½“ */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .move-up {
            background-color: #28a745;
            color: white;
        }

        .move-down {
            background-color: #ffc107;
            color: black;
        }

        .remove-item {
            background-color: #dc3545;
            color: white;
        }

        .splice-preview {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .splice-preview h4 {
            margin: 0 0 15px 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥é¢„è§ˆæ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        /* ä¼šè®®çºªè¦ç”ŸæˆåŒºåŸŸä¼˜åŒ– */
        .minutes-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 18px; /* å¢å¤§è¡¨å•æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            padding: 14px 16px; /* å¢å¤§è¡¨å•è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .result-area {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 25px; /* å¢å¤§ç»“æœåŒºåŸŸå†…è¾¹è· */
            min-height: 250px; /* å¢å¤§æœ€å°é«˜åº¦ */
            max-height: 450px; /* å¢å¤§æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
            font-size: 18px; /* å¢å¤§ç»“æœåŒºåŸŸå­—ä½“ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
        }

        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 14px 28px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px; /* å¢å¤§æŒ‰é’®å­—ä½“ */
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .btn-small {
            padding: 10px 18px; /* å¢å¤§å°æŒ‰é’®å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§å°æŒ‰é’®å­—ä½“ */
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¼˜åŒ– */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        .status-ready { 
            background-color: #28a745; 
        }
        
        .status-processing { 
            background-color: #ffc107; 
        }

        /* ä¼˜åŒ–ç»“æœæ˜¾ç¤º */
        .optimization-result {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 8px;
            font-size: 16px;
        }

        .optimization-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
        }

        .optimization-improvements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .improvement-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 4px 0;
        }

        .improvement-value {
            font-weight: bold;
            color: #28a745;
        }

        .improvement-value.negative {
            color: #dc3545;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .step-content {
                flex-direction: column;
            }
            
            .step-controls {
                min-width: auto;
            }
            
            .processing-grid {
                grid-template-columns: 1fr;
            }
            
            .minutes-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .workflow-container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .step-header {
                font-size: 16px;
            }
            
            .button-group {
                justify-content: stretch;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ä¼šè®®çºªè¦ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆä¼šè®®çºªè¦ã€‚æ”¯æŒéŸ³é¢‘è£å‰ªã€å‹ç¼©ç­‰é¢„å¤„ç†åŠŸèƒ½ã€‚</p>
        </div>

        <div class="workflow-container">
            <!-- æ­¥éª¤1: éŸ³é¢‘æ–‡ä»¶ä¸Šä¼  -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <span>ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ </span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                            <div class="upload-icon">â˜ï¸</div>
                            <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                            <div class="file-info">
                                æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                                æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                            </div>
                        </div>
                        <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac,.wma">
                        <div id="uploadSuccess" class="success-message">
                            âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn" onclick="document.getElementById('audioFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="processUploadedFile()" id="processUploadBtn" disabled>å¤„ç†æ–‡ä»¶</button>
                            <button class="btn btn-warning" onclick="clearFile()">æ¸…é™¤æ–‡ä»¶</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: éŸ³é¢‘å¤„ç† -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <span>ğŸµ éŸ³é¢‘å¤„ç†</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="processing-grid">
                            <div class="option-group">
                                <label>å¼€å§‹æ—¶é—´ (ç§’):</label>
                                <input type="number" id="startTime" placeholder="0" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>ç»“æŸæ—¶é—´ (ç§’):</label>
                                <input type="number" id="endTime" placeholder="è‡ªåŠ¨" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>å‹ç¼©è´¨é‡:</label>
                                <select id="quality">
                                    <option value="high">é«˜è´¨é‡</option>
                                    <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                                    <option value="low">ä½è´¨é‡</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>
                                    <input type="checkbox" id="enableASROptimization" checked>
                                    å¯ç”¨ASRä¼˜åŒ–é¢„å¤„ç†
                                </label>
                                <div class="help-text">è‡ªåŠ¨ä¼˜åŒ–éŸ³é¢‘ä»¥æé«˜è¯­éŸ³è¯†åˆ«å‡†ç¡®ç‡</div>
                            </div>
                        </div>

                        <div id="asrOptimizationOptions" class="asr-optimization-panel">
                            <div class="optimization-header">ğŸ¯ ASRä¼˜åŒ–è®¾ç½®</div>
                            <div class="optimization-options">
                                <div class="option-row">
                                    <label>
                                        <input type="checkbox" id="normalizeAudio" checked>
                                        éŸ³é¢‘æ ‡å‡†åŒ–
                                    </label>
                                    <span class="option-desc">å¢å¼ºéŸ³é‡ï¼Œæé«˜ä¿¡å™ªæ¯”</span>
                                </div>
                                <div class="option-row">
                                    <label>
                                        <input type="checkbox" id="removeSilence" checked>
                                        å»é™¤é™éŸ³æ®µ
                                    </label>
                                    <span class="option-desc">ç§»é™¤é•¿æ—¶é—´é™éŸ³ï¼Œæé«˜å¤„ç†æ•ˆç‡</span>
                                </div>
                                <div class="option-row">
                                    <label>
                                        <input type="checkbox" id="enhanceVolume" checked>
                                        éŸ³é‡å¢å¼º
                                    </label>
                                    <span class="option-desc">è‡ªåŠ¨è°ƒæ•´éŸ³é‡åˆ°æœ€ä½³æ°´å¹³</span>
                                </div>
                                <div class="option-row">
                                    <label>
                                        <input type="checkbox" id="compressAudio" checked>
                                        åŠ¨æ€èŒƒå›´å‹ç¼©
                                    </label>
                                    <span class="option-desc">å¹³è¡¡éŸ³é‡å·®å¼‚ï¼Œæ”¹å–„è¯†åˆ«æ•ˆæœ</span>
                                </div>
                                <div class="option-row">
                                    <label>ç›®æ ‡é‡‡æ ·ç‡:</label>
                                    <select id="targetSampleRate">
                                        <option value="16000">16kHz (æ ‡å‡†)</option>
                                        <option value="24000" selected>24kHz (æ¨è)</option>
                                        <option value="48000">48kHz (é«˜è´¨é‡)</option>
                                    </select>
                                    <span class="option-desc">24kHzä¸ºASRæœ€ä½³é‡‡æ ·ç‡</span>
                                </div>
                            </div>
                        </div>

                        <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>

                        <div class="progress-container" id="processProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="processAudio()" id="processBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¤„ç†éŸ³é¢‘
                            </button>
                            <button class="btn" onclick="previewAudio()" id="previewBtn" disabled>é¢„è§ˆ</button>
                            <button class="btn btn-danger" onclick="stopProcessing()" id="stopBtn" disabled>åœæ­¢</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: éŸ³é¢‘æ‹¼æ¥ -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <span>ğŸ¬ éŸ³é¢‘æ‹¼æ¥</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="splice-info">
                            <p>é€‰æ‹©å¤šä¸ªå·²å¤„ç†çš„éŸ³é¢‘ç‰‡æ®µï¼ŒæŒ‰é¡ºåºæ‹¼æ¥æˆå®Œæ•´éŸ³é¢‘æ–‡ä»¶</p>
                        </div>
                        
                        <div class="splice-files-container">
                            <div class="splice-files-header">
                                <h4>éŸ³é¢‘ç‰‡æ®µåˆ—è¡¨</h4>
                                <button class="btn btn-small" onclick="addAudioSegment()">æ·»åŠ ç‰‡æ®µ</button>
                            </div>
                            <div class="splice-files-list" id="spliceFilesList">
                                <div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–æ·»åŠ ç‰‡æ®µ</div>
                            </div>
                        </div>

                        <div class="splice-preview" id="splicePreview" style="display: none;">
                            <h4>æ‹¼æ¥é¢„è§ˆ</h4>
                            <audio id="spliceAudioPlayer" class="audio-player" controls>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        </div>

                        <div class="progress-container" id="spliceProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="spliceProgressFill"></div>
                            </div>
                            <div class="progress-text" id="spliceProgressText">æ‹¼æ¥ä¸­...</div>
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="spliceAudio()" id="spliceBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¼€å§‹æ‹¼æ¥
                            </button>
                            <button class="btn" onclick="previewSplice()" id="previewSpliceBtn" disabled>é¢„è§ˆæ‹¼æ¥</button>
                            <button class="btn btn-primary" onclick="downloadSplicedAudio()" id="downloadSpliceBtn" disabled>ä¸‹è½½æ‹¼æ¥éŸ³é¢‘</button>
                            <button class="btn btn-warning" onclick="clearSpliceList()">æ¸…ç©ºåˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤4: ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <span>ğŸ“ ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="minutes-form">
                            <div class="form-group">
                                <label>å‚ä¸äººæ•°:</label>
                                <input type="number" id="participantCount" placeholder="è¯·è¾“å…¥å‚ä¸äººæ•°" min="1" max="50" value="5">
                            </div>
                            <div class="form-group">
                                <label>ä¼šè®®ä¸»é¢˜:</label>
                                <input type="text" id="meetingTopic" placeholder="è¯·è¾“å…¥ä¼šè®®ä¸»é¢˜">
                            </div>
                        </div>

                        <div class="result-area" id="minutesResult">
                            æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="generateMinutes()" id="generateBtn" disabled>
                                <span class="status-indicator status-ready"></span>ç”Ÿæˆä¼šè®®çºªè¦
                            </button>
                            <button class="btn" onclick="downloadMinutes()" id="downloadBtn" disabled>ä¸‹è½½çºªè¦</button>
                            <button class="btn btn-warning" onclick="clearMinutes()">æ¸…ç©ºç»“æœ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let processedAudioUrl = null;
        let isProcessing = false;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('audioFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            console.log('ä¼šè®®çºªè¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        async function uploadFile(file) {
            console.log('uploadFile å‡½æ•°è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file);
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/aac', 'audio/ogg', 'audio/flac', 'audio/x-ms-wma'];
            if (!allowedTypes.includes(file.type)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ã€‚');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°è¶…è¿‡100MBé™åˆ¶ï¼');
                return;
            }

            // å­˜å‚¨æ–‡ä»¶
            uploadedFile = file;
            processedAudioUrl = URL.createObjectURL(file);

            // æ›´æ–°UIæ˜¾ç¤º - æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadArea = document.getElementById('uploadArea');
            const uploadSuccess = document.getElementById('uploadSuccess');
            const resultArea = document.getElementById('minutesResult');
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            uploadArea.innerHTML = `
                <div class="upload-icon">â³</div>
                <div class="upload-text">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>
                <div class="file-info">
                    <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                    <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>ç±»å‹:</strong> ${file.type}
                </div>
            `;
            
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('audio_file', file);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                // ä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°UI
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</div>
                    <div class="file-info">
                        <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                        <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <strong>ç±»å‹:</strong> ${file.type}
                    </div>
                `;
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                uploadSuccess.style.display = 'block';
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ç°åœ¨å¯ä»¥ç›´æ¥ç”Ÿæˆä¼šè®®çºªè¦ã€‚';
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶ID
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id;
                
                // å¯ç”¨ç”Ÿæˆä¼šè®®çºªè¦æŒ‰é’®ï¼Œä¿æŒå¤„ç†æ–‡ä»¶æŒ‰é’®å¯ç”¨ï¼ˆç”¨äºASRä¼˜åŒ–ç­‰åŠŸèƒ½ï¼‰
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('processUploadBtn').disabled = false;
                document.getElementById('processBtn').disabled = false;
                
                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                if (audioPlayer) {
                    audioPlayer.src = processedAudioUrl;
                    audioPlayer.style.display = 'block';
                }

                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                
                // ä¸Šä¼ å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                uploadArea.innerHTML = `
                    <div class="upload-icon">âŒ</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ å¤±è´¥</div>
                    <div class="file-info">
                        <strong>é”™è¯¯:</strong> ${error.message}
                    </div>
                `;
                
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
                
                // ä¿æŒæŒ‰é’®ç¦ç”¨çŠ¶æ€
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('processUploadBtn').disabled = true;
                document.getElementById('processBtn').disabled = true;
            }
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå®é™…ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
        async function processUploadedFile() {
            if (!uploadedFile) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            document.getElementById('processUploadBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');
            const originalText = resultArea.textContent;
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨ASRä¼˜åŒ–
                const enableOptimization = document.getElementById('enableASROptimization').checked;
                
                if (enableOptimization) {
                    resultArea.textContent = 'æ­£åœ¨è¿›è¡ŒASRä¼˜åŒ–é¢„å¤„ç†...';
                    await optimizeAudioForASR();
                    resultArea.textContent = 'ASRä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';
                }

                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å¯ä»¥å¼€å§‹ç”Ÿæˆä¼šè®®çºªè¦æˆ–å¤„ç†éŸ³é¢‘ã€‚';
                document.getElementById('processBtn').disabled = false; // å¯ç”¨éŸ³é¢‘å¤„ç†æŒ‰é’®
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶IDï¼Œä¾›åç»­ä½¿ç”¨
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id; // ç›´æ¥ä½¿ç”¨dify_file_idä½œä¸ºåŸå§‹æ–‡ä»¶ID
                
                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
                document.getElementById('processUploadBtn').disabled = false;
            }
        }

        // ASRä¼˜åŒ–é¢„å¤„ç†å‡½æ•°
        async function optimizeAudioForASR() {
            if (!uploadedFile) {
                throw new Error('æ²¡æœ‰å¯ä¼˜åŒ–çš„éŸ³é¢‘æ–‡ä»¶');
            }

            try {
                // è·å–ä¼˜åŒ–å‚æ•°
                const targetSampleRate = parseInt(document.getElementById('targetSampleRate').value);
                const enableNormalization = document.getElementById('normalizeAudio').checked;
                const enableSilenceRemoval = document.getElementById('removeSilence').checked;
                const enableVolumeEnhancement = document.getElementById('enhanceVolume').checked;
                const enableDynamicCompression = document.getElementById('compressAudio').checked;

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                formData.append('target_sample_rate', targetSampleRate);
                formData.append('enable_normalization', enableNormalization);
                formData.append('enable_silence_removal', enableSilenceRemoval);
                formData.append('enable_volume_enhancement', enableVolumeEnhancement);
                formData.append('enable_dynamic_compression', enableDynamicCompression);

                const response = await fetch('/meeting_minutes/optimize_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘ä¼˜åŒ–å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘ä¼˜åŒ–å¤±è´¥');
                }

                // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
                displayOptimizationResult(result);

                // åˆ›å»ºä¼˜åŒ–åçš„æ–‡ä»¶å¯¹è±¡
                const optimizedBlob = await fetch(result.optimized_file_url).then(r => r.blob());
                const optimizedFile = new File([optimizedBlob], result.optimized_filename, { type: 'audio/mpeg' });
                
                // æ›¿æ¢åŸå§‹æ–‡ä»¶
                uploadedFile = optimizedFile;
                
                console.log('éŸ³é¢‘ä¼˜åŒ–å®Œæˆ:', result);
                
            } catch (error) {
                console.error('éŸ³é¢‘ä¼˜åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        function displayOptimizationResult(result) {
            const resultDiv = document.getElementById('optimizationResult');
            if (!resultDiv) return;

            const improvements = result.improvements || {};
            
            let html = `
                <div class="optimization-result">
                    <strong>âœ… ASRä¼˜åŒ–å®Œæˆ</strong>
                    <div class="optimization-improvements">
                        <div class="improvement-item">
                            <span>é‡‡æ ·ç‡:</span>
                            <span class="improvement-value">${improvements.sample_rate_before || 'N/A'} â†’ ${improvements.sample_rate_after || 'N/A'} Hz</span>
                        </div>
                        <div class="improvement-item">
                            <span>å£°é“:</span>
                            <span class="improvement-value">${improvements.channels_before || 'N/A'} â†’ ${improvements.channels_after || 1}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ—¶é•¿å˜åŒ–:</span>
                            <span class="improvement-value">${improvements.duration_change || 'N/A'}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ–‡ä»¶å¤§å°:</span>
                            <span class="improvement-value">${formatFileSize(result.original_info?.file_size || 0)} â†’ ${formatFileSize(result.optimized_info?.file_size || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆ‡æ¢ä¼˜åŒ–é€‰é¡¹æ˜¾ç¤º/éšè—
        function toggleOptimizationOptions() {
            const checkbox = document.getElementById('enableASROptimization');
            const panel = document.getElementById('optimizationOptionsPanel');
            const result = document.getElementById('optimizationResult');
            
            if (checkbox.checked) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
                if (result) result.style.display = 'none';
            }
        }

        function clearFile() {
            uploadedFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('processUploadBtn').disabled = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
        }

        // éŸ³é¢‘å¤„ç†ç›¸å…³
        async function processAudio() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
            if (!uploadedFile.dify_file_id) {
                alert('è¯·å…ˆç‚¹å‡»"å¤„ç†æ–‡ä»¶"ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            isProcessing = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

            try {
                // è·å–å¤„ç†å‚æ•°
                const startTime = parseFloat(document.getElementById('startTime').value) || 0;
                const endTime = parseFloat(document.getElementById('endTime').value) || null;
                const quality = document.getElementById('quality').value;
                const compress = quality !== 'high'; // é«˜è´¨é‡ä¸å‹ç¼©ï¼Œä¸­ç­‰å’Œä½è´¨é‡å‹ç¼©

                // è°ƒç”¨åç«¯éŸ³é¢‘å¤„ç†API
                const response = await fetch('/meeting_minutes/process_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: uploadedFile.original_file_id || uploadedFile.name.split('.')[0],
                        start_time: startTime,
                        end_time: endTime,
                        compress: compress
                    })
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                // å¤„ç†æˆåŠŸï¼Œä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶åˆ°Dify
                document.getElementById('progressText').textContent = 'æ­£åœ¨ä¸Šä¼ å¤„ç†åçš„éŸ³é¢‘...';
                
                const uploadResponse = await fetch('/meeting_minutes/upload_processed_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processed_file_id: result.processed_file_id
                    })
                });

                if (!uploadResponse.ok) {
                    throw new Error('å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                // ä¿å­˜å¤„ç†åçš„æ–‡ä»¶ä¿¡æ¯
                uploadedFile.processed_file_id = result.processed_file_id; // ä½¿ç”¨æœ¬åœ°å¤„ç†ç»“æœçš„ID
                uploadedFile.processed_filename = result.processed_filename;
                uploadedFile.processed_file_url = result.processed_file_url; // ä¿å­˜å¤„ç†åéŸ³é¢‘æ–‡ä»¶çš„URL
                uploadedFile.duration = result.duration; // ä¿å­˜éŸ³é¢‘æ—¶é•¿
                uploadedFile.dify_processed_file_id = uploadResult.dify_file_id; // ä¿å­˜Difyä¸Šä¼ åçš„ID
                
                finishProcessing();
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                document.getElementById('progressText').textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
                stopProcessing();
                alert('éŸ³é¢‘å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        function finishProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('progressText').textContent = 'å¤„ç†å®Œæˆï¼';
            
            setTimeout(() => {
                document.getElementById('processProgress').style.display = 'none';
            }, 2000);
            
            // å¦‚æœæœ‰å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶URLï¼Œæ›´æ–°éŸ³é¢‘æ’­æ”¾å™¨çš„src
            if (uploadedFile && uploadedFile.processed_file_url) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = uploadedFile.processed_file_url;
                processedAudioUrl = uploadedFile.processed_file_url;
                console.log('éŸ³é¢‘æ’­æ”¾å™¨å·²æ›´æ–°ä¸ºå¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶:', uploadedFile.processed_file_url);
            } else {
                processedAudioUrl = document.getElementById('audioPlayer').src;
            }
            
            console.log('éŸ³é¢‘å¤„ç†å®Œæˆ');
        }

        function previewAudio() {
            if (processedAudioUrl) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.currentTime = document.getElementById('startTime').value || 0;
                audioPlayer.play();
            }
        }

        function stopProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('processProgress').style.display = 'none';
        }

        // ä¼šè®®çºªè¦ç”Ÿæˆç›¸å…³
        async function generateMinutes() {
            if (!uploadedFile && !splicedAudioUrl) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹¼æ¥éŸ³é¢‘ï¼');
                return;
            }

            const participantCount = document.getElementById('participantCount').value;
            const meetingTopic = document.getElementById('meetingTopic').value;
            
            if (!participantCount) {
                alert('è¯·è¾“å…¥å‚ä¸äººæ•°ï¼');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');

            try {
                let fileId;
                
                // æ–‡ä»¶ä¼˜å…ˆçº§ï¼šæ‹¼æ¥æ–‡ä»¶ > å¤„ç†åæ–‡ä»¶ > åŸå§‹æ–‡ä»¶
                if (splicedAudioUrl && splicedAudioFilename) {
                    // 1. ä¼˜å…ˆä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶
                    resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ‹¼æ¥åçš„éŸ³é¢‘æ–‡ä»¶...';
                    console.log('ä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶:', splicedAudioFilename);
                    
                    // éœ€è¦å…ˆå°†æ‹¼æ¥æ–‡ä»¶ä¸Šä¼ åˆ°Difyè·å–file_id
                    try {
                        const response = await fetch(splicedAudioUrl);
                        const blob = await response.blob();
                        const file = new File([blob], splicedAudioFilename, { type: 'audio/mpeg' });
                        
                        const formData = new FormData();
                        formData.append('audio_file', file);
                        
                        const uploadResp = await fetch('/meeting_minutes/upload_audio', {
                            method: 'POST',
                            body: formData
                        });

                        if (!uploadResp.ok) {
                            throw new Error('æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                        }

                        const uploadData = await uploadResp.json();
                        if (!uploadData.success || !uploadData.dify_file_id) {
                            throw new Error('æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (uploadData.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                        
                        fileId = uploadData.dify_file_id;
                        resultArea.textContent = 'æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦...';
                    } catch (error) {
                        console.error('æ‹¼æ¥æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–æ–‡ä»¶:', error);
                        // å¦‚æœæ‹¼æ¥æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œé™çº§åˆ°å¤„ç†åçš„æ–‡ä»¶
                         if (uploadedFile && uploadedFile.dify_processed_file_id) {
                             fileId = uploadedFile.dify_processed_file_id;
                             resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                             console.log('é™çº§ä½¿ç”¨å¤„ç†åæ–‡ä»¶çš„Dify ID:', fileId);
                        } else if (uploadedFile && uploadedFile.dify_file_id) {
                            fileId = uploadedFile.dify_file_id;
                            resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                            console.log('é™çº§ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                        } else {
                            throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘æ–‡ä»¶');
                        }
                    }
                } else if (uploadedFile && uploadedFile.dify_processed_file_id) {
                    // 2. ä½¿ç”¨å¤„ç†åæ–‡ä»¶ä¸Šä¼ åˆ°Difyçš„ID
                    fileId = uploadedFile.dify_processed_file_id;
                    resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨å¤„ç†åæ–‡ä»¶çš„Dify ID:', fileId);
                } else if (uploadedFile && uploadedFile.dify_file_id) {
                    // 3. ä½¿ç”¨åŸå§‹æ–‡ä»¶ID
                    fileId = uploadedFile.dify_file_id;
                    resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                } else {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘æ–‡ä»¶');
                }

                // 2. è°ƒç”¨ç”Ÿæˆä¼šè®®çºªè¦çš„API
                const generateResp = await fetch('/meeting_minutes/generate_minutes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: fileId,
                        participants_count: parseInt(participantCount),
                        additional_info: meetingTopic || ''
                    })
                });

                if (!generateResp.ok) {
                    throw new Error('ä¼šè®®çºªè¦ç”Ÿæˆæ¥å£è°ƒç”¨å¤±è´¥');
                }

                // 3. å¤„ç†æµå¼å“åº”
                const reader = generateResp.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let result = '';

                resultArea.textContent = 'æ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦ï¼Œè¯·ç¨å€™...';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split(/\n\n/);
                    buffer = lines.pop();

                    for (let line of lines) {
                        if (line.startsWith('data:')) {
                            let content = line.slice(5).trim();
                            if (content.startsWith('[ERROR]')) {
                                throw new Error(content);
                            } else {
                                try {
                                    let obj = JSON.parse(content);
                                    
                                    // å¤„ç†Difyå·¥ä½œæµçš„å“åº”
                                    if (obj.event === 'message' && obj.answer) {
                                        result += obj.answer;
                                        resultArea.textContent = result;
                                    } else if (obj.event === 'message_end') {
                                        // ç”Ÿæˆå®Œæˆ
                                        document.getElementById('downloadBtn').disabled = false;
                                        console.log('ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆ');
                                        break;
                                    } else if (obj.event === 'error') {
                                        throw new Error(obj.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æå¤±è´¥çš„ç‰‡æ®µï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„JSON
                                    console.warn('JSONè§£æå¤±è´¥:', content);
                                }
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰è·å¾—ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                if (!result.trim()) {
                    resultArea.textContent = 'ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆï¼Œä½†æœªè·å¾—æœ‰æ•ˆå†…å®¹ã€‚è¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶è´¨é‡æˆ–é‡è¯•ã€‚';
                }

            } catch (error) {
                console.error('ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥:', error);
                resultArea.textContent = 'ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥: ' + error.message;
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function downloadMinutes() {
            const content = document.getElementById('minutesResult').textContent;
            if (!content || content.includes('ç­‰å¾…éŸ³é¢‘å¤„ç†')) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¼šè®®çºªè¦ï¼');
                return;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¼šè®®çºªè¦_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearMinutes() {
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
        }

        function clearFile() {
            // é‡ç½®æ–‡ä»¶ç›¸å…³å˜é‡
            uploadedFile = null;
            processedAudioUrl = null;
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">â˜ï¸</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="file-info">
                    æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                    æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                </div>
            `;
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('audioFile').value = '';
            
            // éšè—æˆåŠŸæ¶ˆæ¯
            document.getElementById('uploadSuccess').style.display = 'none';
            
            // ç¦ç”¨ç›¸å…³æŒ‰é’®
            document.getElementById('processUploadBtn').disabled = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            
            // éšè—éŸ³é¢‘æ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            
            // é‡ç½®ä¼šè®®çºªè¦ç»“æœ
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
            
            console.log('æ–‡ä»¶å·²æ¸…é™¤');
        }

        // éŸ³é¢‘æ‹¼æ¥ç›¸å…³å˜é‡å’Œå‡½æ•°
        let spliceSegments = [];
        let splicedAudioUrl = null;
        let splicedAudioFilename = null;

        // æ·»åŠ éŸ³é¢‘ç‰‡æ®µåˆ°æ‹¼æ¥åˆ—è¡¨
        function addAudioSegment() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // ç¡®å®šä½¿ç”¨çš„æ–‡ä»¶IDå’Œç›¸å…³ä¿¡æ¯
            let fileId, filename, fileUrl;
            
            if (uploadedFile.processed_file_id) {
                // ä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶
                fileId = uploadedFile.processed_file_id;
                filename = uploadedFile.processed_filename || `${uploadedFile.processed_file_id}.mp3`;
                // æ„å»ºå®Œæ•´çš„URLç”¨äºé¢„è§ˆ
                fileUrl = window.location.origin + uploadedFile.processed_file_url;
            } else if (uploadedFile.dify_file_id) {
                // ä½¿ç”¨åŸå§‹æ–‡ä»¶
                fileId = uploadedFile.dify_file_id;
                filename = uploadedFile.name;
                fileUrl = URL.createObjectURL(uploadedFile);
            } else {
                alert('è¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªç‰‡æ®µ
            const existingSegment = spliceSegments.find(seg => seg.file_id === fileId);
            if (existingSegment) {
                alert('è¯¥éŸ³é¢‘ç‰‡æ®µå·²åœ¨æ‹¼æ¥åˆ—è¡¨ä¸­ï¼');
                return;
            }

            // æ·»åŠ åˆ°æ‹¼æ¥åˆ—è¡¨
            const segment = {
                file_id: fileId,
                filename: filename,
                duration: uploadedFile.duration || 0,
                url: fileUrl
            };

            spliceSegments.push(segment);
            updateSpliceList();
            updateSpliceButtons();
            
            console.log('æ·»åŠ éŸ³é¢‘ç‰‡æ®µ:', segment);
        }

        // æ›´æ–°æ‹¼æ¥åˆ—è¡¨æ˜¾ç¤º
        function updateSpliceList() {
            const listContainer = document.getElementById('spliceFilesList');
            
            if (spliceSegments.length === 0) {
                listContainer.innerHTML = '<div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–æ·»åŠ ç‰‡æ®µ</div>';
                return;
            }

            let html = '';
            spliceSegments.forEach((segment, index) => {
                html += `
                    <div class="splice-item" data-index="${index}">
                        <div class="splice-item-info">
                            <div class="splice-item-name">${segment.filename}</div>
                            <div class="splice-item-duration">æ—¶é•¿: ${formatDuration(segment.duration)}</div>
                        </div>
                        <div class="splice-item-controls">
                            <button class="move-up" onclick="moveSpliceItem(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                            <button class="move-down" onclick="moveSpliceItem(${index}, 1)" ${index === spliceSegments.length - 1 ? 'disabled' : ''}>â†“</button>
                            <button class="remove-item" onclick="removeSpliceItem(${index})">Ã—</button>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // ç§»åŠ¨æ‹¼æ¥é¡¹ç›®
         function moveSpliceItem(index, direction) {
             const newIndex = index + direction;
             if (newIndex < 0 || newIndex >= spliceSegments.length) return;

             // äº¤æ¢ä½ç½®
             [spliceSegments[index], spliceSegments[newIndex]] = [spliceSegments[newIndex], spliceSegments[index]];
             updateSpliceList();
         }

         // åˆ é™¤æ‹¼æ¥é¡¹ç›®
         function removeSpliceItem(index) {
             spliceSegments.splice(index, 1);
             updateSpliceList();
             updateSpliceButtons();
         }

         // æ›´æ–°æ‹¼æ¥ç›¸å…³æŒ‰é’®çŠ¶æ€
         function updateSpliceButtons() {
             const hasSegments = spliceSegments.length > 0;
             document.getElementById('spliceBtn').disabled = !hasSegments;
             document.getElementById('previewSpliceBtn').disabled = !hasSegments;
         }

         // å¼€å§‹æ‹¼æ¥éŸ³é¢‘
         async function spliceAudio() {
             if (spliceSegments.length === 0) {
                 alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                 return;
             }

             document.getElementById('spliceBtn').disabled = true;
             document.getElementById('spliceProgress').style.display = 'block';
             document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨æ‹¼æ¥éŸ³é¢‘...';

             try {
                 const response = await fetch('/meeting_minutes/splice_audio', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         segments: spliceSegments.map(seg => ({
                             file_id: seg.file_id,
                             filename: seg.filename
                         }))
                     })
                 });

                 if (!response.ok) {
                     throw new Error('éŸ³é¢‘æ‹¼æ¥å¤±è´¥');
                 }

                 const result = await response.json();
                 if (result.success) {
                     // æ„å»ºå®Œæ•´çš„URL
                     const fullUrl = window.location.origin + result.spliced_file_url;
                     splicedAudioUrl = fullUrl;
                     splicedAudioFilename = result.spliced_filename;
                     document.getElementById('spliceProgressText').textContent = 'æ‹¼æ¥å®Œæˆï¼';
                     document.getElementById('downloadSpliceBtn').disabled = false;
                     
                     // æ˜¾ç¤ºé¢„è§ˆ
                     const previewContainer = document.getElementById('splicePreview');
                     const audioPlayer = document.getElementById('spliceAudioPlayer');
                     audioPlayer.src = fullUrl;
                     previewContainer.style.display = 'block';
                     
                     setTimeout(() => {
                         document.getElementById('spliceProgress').style.display = 'none';
                     }, 2000);
                 } else {
                     throw new Error(result.error || 'æ‹¼æ¥å¤±è´¥');
                 }

             } catch (error) {
                 console.error('éŸ³é¢‘æ‹¼æ¥å¤±è´¥:', error);
                 document.getElementById('spliceProgressText').textContent = 'æ‹¼æ¥å¤±è´¥: ' + error.message;
                 setTimeout(() => {
                     document.getElementById('spliceProgress').style.display = 'none';
                 }, 3000);
             } finally {
                 document.getElementById('spliceBtn').disabled = false;
             }
         }

         // é¢„è§ˆæ‹¼æ¥æ•ˆæœ
         async function previewSplice() {
             if (spliceSegments.length === 0) {
                 alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                 return;
             }

             // å¦‚æœå·²ç»æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œç›´æ¥é¢„è§ˆ
             if (splicedAudioUrl) {
                 const previewContainer = document.getElementById('splicePreview');
                 const audioPlayer = document.getElementById('spliceAudioPlayer');
                 audioPlayer.src = splicedAudioUrl;
                 previewContainer.style.display = 'block';
                 audioPlayer.play();
                 return;
             }

             // å¦‚æœæ²¡æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œå…ˆæ‰§è¡Œæ‹¼æ¥
             try {
                 document.getElementById('previewSpliceBtn').disabled = true;
                 document.getElementById('previewSpliceBtn').textContent = 'æ­£åœ¨æ‹¼æ¥...';
                 
                 await spliceAudio();
                 
                 // æ‹¼æ¥å®Œæˆåé¢„è§ˆ
                 if (splicedAudioUrl) {
                     const previewContainer = document.getElementById('splicePreview');
                     const audioPlayer = document.getElementById('spliceAudioPlayer');
                     audioPlayer.src = splicedAudioUrl;
                     previewContainer.style.display = 'block';
                     audioPlayer.play();
                 }
             } catch (error) {
                 console.error('é¢„è§ˆæ‹¼æ¥å¤±è´¥:', error);
                 alert('é¢„è§ˆæ‹¼æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
             } finally {
                 document.getElementById('previewSpliceBtn').disabled = false;
                 document.getElementById('previewSpliceBtn').textContent = 'é¢„è§ˆæ‹¼æ¥';
             }
         }

         // ä¸‹è½½æ‹¼æ¥åçš„éŸ³é¢‘
         function downloadSplicedAudio() {
             if (!splicedAudioUrl) {
                 alert('è¯·å…ˆæ‹¼æ¥éŸ³é¢‘ï¼');
                 return;
             }

             const a = document.createElement('a');
             a.href = splicedAudioUrl;
             a.download = splicedAudioFilename || `æ‹¼æ¥éŸ³é¢‘_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.mp3`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
         }

         // æ¸…ç©ºæ‹¼æ¥åˆ—è¡¨
         function clearSpliceList() {
             spliceSegments = [];
             splicedAudioUrl = null;
             splicedAudioFilename = null;
             updateSpliceList();
             updateSpliceButtons();
             document.getElementById('splicePreview').style.display = 'none';
             document.getElementById('downloadSpliceBtn').disabled = true;
         }

         // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
         function formatDuration(seconds) {
             if (!seconds || seconds === 0) return 'æœªçŸ¥';
             const minutes = Math.floor(seconds / 60);
             const remainingSeconds = Math.floor(seconds % 60);
             return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
         }
     </script>
 </body>
 </html>
