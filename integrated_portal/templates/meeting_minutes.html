<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®çºªè¦ç³»ç»Ÿ - ç»Ÿä¸€é—¨æˆ·ç³»ç»Ÿ</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* æ–°çš„æµç¨‹å¼å¸ƒå±€ */
        .workflow-container {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .workflow-step {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: fit-content;
            min-height: 600px; /* è®¾ç½®ç»Ÿä¸€çš„æœ€å°é«˜åº¦ */
        }

        .workflow-step:hover {
            border-color: #007bff;
            box-shadow: 0 4px 16px rgba(0,123,255,0.1);
        }

        .step-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 10px 15px;
            margin: -15px -15px 15px -15px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .step-number {
            background: rgba(255,255,255,0.2);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .step-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }

        .step-main {
            flex: 2;
        }

        .step-controls {
            flex: 1;
            min-width: 300px;
        }

        /* éŸ³é¢‘ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #fafafa, #f0f0f0);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: linear-gradient(135deg, #e6f3ff, #cce7ff);
        }

        .upload-icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #333;
            font-size: 20px; /* å¢å¤§ä¸Šä¼ æ–‡æœ¬å­—ä½“ */
            font-weight: 500;
            margin-bottom: 10px;
        }

        .file-info {
            color: #666;
            font-size: 16px; /* å¢å¤§æ–‡ä»¶ä¿¡æ¯å­—ä½“ */
            line-height: 1.5;
        }

        .file-input {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px; /* å¢å¤§æˆåŠŸæ¶ˆæ¯å­—ä½“ */
            display: none;
            border-left: 4px solid #28a745;
        }

        /* éŸ³é¢‘å¤„ç†åŒºåŸŸä¼˜åŒ– */
        .processing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-group label {
            font-size: 18px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .option-group input, .option-group select {
            padding: 12px 14px; /* å¢å¤§è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .option-group input:focus, .option-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            height: 50px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 18px; /* å¢å¤§è¿›åº¦æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 8px;
            text-align: center;
            font-weight: 500;
        }

        /* ASRä¼˜åŒ–é¢æ¿ä¼˜åŒ– */
        .asr-optimization-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #007bff;
            border-radius: 12px;
            border-left: 6px solid #007bff;
        }

        .optimization-header {
            font-size: 20px; /* å¢å¤§ä¼˜åŒ–æ ‡é¢˜å­—ä½“ */
            font-weight: 600;
            color: #007bff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .optimization-options {
            display: grid;
            gap: 15px;
        }

        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .option-row:last-child {
            border-bottom: none;
        }

        .option-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px; /* å¢å¤§é€‰é¡¹æ ‡ç­¾å­—ä½“ */
            color: #333;
            cursor: pointer;
            min-width: 200px;
            font-weight: 500;
        }

        .option-row input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .option-row select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 150px;
        }

        .option-desc {
            font-size: 16px; /* å¢å¤§é€‰é¡¹æè¿°å­—ä½“ */
            color: #666;
            font-style: italic;
            flex: 1;
            text-align: right;
        }

        .help-text {
            font-size: 16px; /* å¢å¤§å¸®åŠ©æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* éŸ³é¢‘æ‹¼æ¥åŒºåŸŸä¼˜åŒ– */
        .splice-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥ä¿¡æ¯å­—ä½“ */
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .splice-files-container {
            margin-bottom: 20px;
        }

        .splice-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .splice-files-header h4 {
            margin: 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥æ–‡ä»¶æ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .splice-files-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            min-height: 120px;
            padding: 15px;
            background-color: #fafafa;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-size: 18px; /* å¢å¤§ç©ºæ¶ˆæ¯å­—ä½“ */
            padding: 30px;
        }

        .splice-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 18px; /* å¢å¤§å†…è¾¹è· */
            margin-bottom: 8px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹å­—ä½“ */
            transition: all 0.3s ease;
        }

        .splice-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }

        .splice-item:last-child {
            margin-bottom: 0;
        }

        .splice-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .splice-item-name {
            font-weight: 600;
            color: #333;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹åç§°å­—ä½“ */
        }

        .file-type-label {
            font-size: 14px;
            color: #888;
            font-weight: normal;
            margin-left: 8px;
        }

        .splice-item-duration {
            color: #666;
            font-size: 16px; /* å¢å¤§æ‹¼æ¥é¡¹æ—¶é•¿å­—ä½“ */
        }

        .splice-item-controls {
            display: flex;
            gap: 8px;
        }

        .splice-item-controls button {
            padding: 8px 14px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§æŒ‰é’®å­—ä½“ */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .move-up {
            background-color: #28a745;
            color: white;
        }

        .move-down {
            background-color: #ffc107;
            color: black;
        }

        .remove-item {
            background-color: #dc3545;
            color: white;
        }

        .splice-preview {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .splice-preview h4 {
            margin: 0 0 15px 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥é¢„è§ˆæ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        /* ä¼šè®®çºªè¦ç”ŸæˆåŒºåŸŸä¼˜åŒ– */
        .minutes-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 18px; /* å¢å¤§è¡¨å•æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            padding: 14px 16px; /* å¢å¤§è¡¨å•è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .result-area {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px; /* å‡å°‘å†…è¾¹è·ï¼Œè®©æ–‡æœ¬æ›´è´´è¿‘è¾¹æ¡† */
            min-height: 350px; /* å¢å¤§æœ€å°é«˜åº¦ä»¥åŒ¹é…å…¶ä»–å¡ç‰‡ */
            max-height: 450px; /* å¢å¤§æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
            font-size: 18px; /* å¢å¤§ç»“æœåŒºåŸŸå­—ä½“ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
            text-align: left; /* ç¡®ä¿æ–‡æœ¬å·¦å¯¹é½ */
        }

        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 40px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #e0a800, #d39e00);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            min-height: 32px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }

        /* è¡¨å•æ§ä»¶ä¼˜åŒ– */
        .form-control {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        /* ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-text {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
            margin: 0;
        }

        /* è¿›åº¦æ¡ä¼˜åŒ– */
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¼˜åŒ– */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        .status-ready { 
            background-color: #28a745; 
        }
        
        .status-processing { 
            background-color: #ffc107; 
        }

        /* ä¼˜åŒ–ç»“æœæ˜¾ç¤º */
        .optimization-result {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 8px;
            font-size: 16px;
        }

        .optimization-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
        }

        .optimization-improvements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .improvement-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 4px 0;
        }

        .improvement-value {
            font-weight: bold;
            color: #28a745;
        }

        .improvement-value.negative {
            color: #dc3545;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal.hide {
            opacity: 0;
            visibility: hidden;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            background-color: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .asr-trigger-label {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 6px;
        }

        .asr-trigger-label:hover {
            background-color: #f0f0f0;
        }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
        }
        </style>

        <script>
         // æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
         function openSpliceAsrModal() {
             const modal = document.getElementById('spliceAsrOptimizationModal');
             if (modal) {
                 modal.classList.add('show');
                 modal.style.display = 'flex';
             }
         }

         function closeSpliceAsrModal() {
             const modal = document.getElementById('spliceAsrOptimizationModal');
             modal.classList.add('hide');
             modal.classList.remove('show');
             setTimeout(() => {
                 modal.classList.remove('hide');
             }, 300);
         }

         function applySpliceAsrSettings() {
             // è·å–æ‰€æœ‰è®¾ç½®å€¼
             const settings = {
                 normalizeAudio: document.getElementById('spliceNormalizeAudio').checked,
                 removeSilence: document.getElementById('spliceRemoveSilence').checked,
                 enhanceVolume: document.getElementById('spliceEnhanceVolume').checked,
                 compressAudio: document.getElementById('spliceCompressAudio').checked,
                 targetSampleRate: document.getElementById('spliceTargetSampleRate').value
             };

             // æ›´æ–°ä¸»é¡µé¢çš„ASRä¼˜åŒ–checkboxçŠ¶æ€
             const enableSpliceASROptimization = document.getElementById('enableSpliceASROptimization');
             const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                      settings.enhanceVolume || settings.compressAudio;
             enableSpliceASROptimization.checked = hasAnyOptimization;

             // ä¿å­˜è®¾ç½®åˆ°å…¨å±€å˜é‡æˆ–localStorage
             window.spliceAsrSettings = settings;
             localStorage.setItem('spliceAsrSettings', JSON.stringify(settings));

             closeSpliceAsrModal();
             
             // æ˜¾ç¤ºåº”ç”¨æˆåŠŸæç¤º
             const helpText = document.querySelector('#spliceAsrOptimizationTrigger').parentElement.nextElementSibling;
             const originalText = helpText.textContent;
             helpText.textContent = 'âœ“ è®¾ç½®å·²åº”ç”¨';
             helpText.style.color = '#28a745';
             setTimeout(() => {
                 helpText.textContent = originalText;
                 helpText.style.color = '';
             }, 2000);
         }
         </script>
    </style>

    <!-- å“åº”å¼è®¾è®¡ -->
    <style>
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .workflow-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .step-content {
                flex-direction: column;
            }
            
            .step-controls {
                min-width: auto;
            }
            
            .processing-grid {
                grid-template-columns: 1fr;
            }
            
            .minutes-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .workflow-container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .container {
                height: auto;
                min-height: calc(100vh - 20px);
                margin: 10px;
            }
            
            .workflow-step {
                padding: 12px;
            }
            
            .step-header {
                padding: 8px 12px;
                margin: -12px -12px 12px -12px;
                font-size: 14px;
            }
            
            .step-number {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 12px;
                min-height: 36px;
            }
            
            .upload-area {
                padding: 15px;
                min-height: 80px;
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* éŸ³é¢‘æ‹¼æ¥å¡ç‰‡ç‰¹æ®Šæ ·å¼ - è°ƒæ•´å†…å®¹åŒºåŸŸé«˜åº¦ä»¥å¯¹é½æŒ‰é’® */
        .workflow-step:nth-child(2) .step-main {
            min-height: 450px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ä¼šè®®çºªè¦ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆä¼šè®®çºªè¦ã€‚æ”¯æŒéŸ³é¢‘è£å‰ªã€å‹ç¼©ç­‰é¢„å¤„ç†åŠŸèƒ½ã€‚</p>
        </div>

        <div class="workflow-container">
            <!-- æ­¥éª¤1: éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ä¸å¤„ç† -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <span>ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ä¸å¤„ç†</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                            <div class="upload-icon">â˜ï¸</div>
                            <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                            <div class="file-info">
                                æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                                æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                            </div>
                        </div>
                        <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac,.wma">
                        <div id="uploadSuccess" class="success-message">
                            âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼
                        </div>

                        <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>

                        <div class="processing-grid">
                            <div class="option-group">
                                <label>å¼€å§‹æ—¶é—´ (ç§’):</label>
                                <input type="number" id="startTime" placeholder="0" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>ç»“æŸæ—¶é—´ (ç§’):</label>
                                <input type="number" id="endTime" placeholder="è‡ªåŠ¨" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>å‹ç¼©è´¨é‡:</label>
                                <select id="quality">
                                    <option value="high">é«˜è´¨é‡</option>
                                    <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                                    <option value="low">ä½è´¨é‡</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label id="asrOptimizationTrigger" class="asr-trigger-label">
                                    <input type="checkbox" id="enableASROptimization">
                                    å¯ç”¨ASRä¼˜åŒ–é¢„å¤„ç†
                                </label>
                                <div class="help-text">ç‚¹å‡»è®¾ç½®ASRä¼˜åŒ–å‚æ•°</div>
                            </div>
                        </div>
                        
                        <!-- ASRä¼˜åŒ–ç»“æœæ˜¾ç¤ºå®¹å™¨ -->
                        <div id="optimizationResult" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;"></div>

                        <div class="progress-container" id="processProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn" onclick="document.getElementById('audioFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="processAudio()" id="processBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¤„ç†éŸ³é¢‘
                            </button>
                            <button class="btn btn-danger" onclick="stopProcessing()" id="stopBtn" disabled style="display: none;">åœæ­¢</button>
                            <button class="btn" onclick="previewAudio()" id="previewBtn" disabled>é¢„è§ˆ</button>
                            <button class="btn btn-warning" onclick="clearFile()">æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: éŸ³é¢‘æ‹¼æ¥ -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <span>ğŸ¬ éŸ³é¢‘æ‹¼æ¥</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="splice-info">
                            <p>é€‰æ‹©å¤šä¸ªå·²å¤„ç†çš„éŸ³é¢‘ç‰‡æ®µï¼ŒæŒ‰é¡ºåºæ‹¼æ¥æˆå®Œæ•´éŸ³é¢‘æ–‡ä»¶</p>
                        </div>
                        
                        <div class="splice-files-container">
                            <div class="splice-files-header">
                                <h4>éŸ³é¢‘ç‰‡æ®µåˆ—è¡¨</h4>
                                <div class="header-controls">
                                    <input type="file" id="localAudioFile" accept="audio/*" multiple style="display: none;" onchange="handleLocalAudioFiles(event)">
                                    <button class="btn btn-small" onclick="document.getElementById('localAudioFile').click()">é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button>
                                    <button class="btn btn-small" onclick="addAudioSegment()">æ·»åŠ å·²å¤„ç†ç‰‡æ®µ</button>
                                </div>
                            </div>
                            <div class="splice-files-list" id="spliceFilesList">
                                <div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–æ·»åŠ ç‰‡æ®µ</div>
                            </div>
                        </div>

                        <div class="splice-preview" id="splicePreview" style="display: none;">
                            <h4>æ‹¼æ¥é¢„è§ˆ</h4>
                            <audio id="spliceAudioPlayer" class="audio-player" controls>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        </div>

                        <div class="progress-container" id="spliceProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="spliceProgressFill"></div>
                            </div>
                            <div class="progress-text" id="spliceProgressText">æ‹¼æ¥ä¸­...</div>
                        </div>
                        
                        <!-- ASRä¼˜åŒ–é€‰é¡¹ -->
                        <div class="option-group" style="margin-top: 15px;">
                            <div class="asr-trigger-container">
                                <label id="spliceAsrOptimizationTrigger" class="asr-trigger-label">
                                    <input type="checkbox" id="enableSpliceASROptimization">
                                    å¯ç”¨ASRä¼˜åŒ–é¢„å¤„ç†ï¼ˆæ‹¼æ¥åï¼‰
                                </label>
                            </div>
                            <div class="help-text">ç‚¹å‡»è®¾ç½®ASRä¼˜åŒ–å‚æ•°</div>
                        </div>
                        
                        <!-- æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–ç»“æœæ˜¾ç¤ºå®¹å™¨ -->
                        <div id="spliceOptimizationResult" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;"></div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="spliceAudio()" id="spliceBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¼€å§‹æ‹¼æ¥
                            </button>
                            <button class="btn" onclick="previewSplice()" id="previewSpliceBtn" disabled>é¢„è§ˆ</button>
                            <button class="btn btn-primary" onclick="downloadSplicedAudio()" id="downloadSpliceBtn" disabled>ä¸‹è½½</button>
                            <button class="btn btn-warning" onclick="clearSpliceList()">æ¸…ç©ºåˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <span>ğŸ“ ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="minutes-form">
                            <div class="form-group">
                                <label>å‚ä¸äººæ•°:</label>
                                <input type="number" id="participantCount" placeholder="è¯·è¾“å…¥å‚ä¸äººæ•°" min="1" max="50" value="2">
                            </div>
                            <div class="form-group">
                                <label>ä¼šè®®ä¸»é¢˜:</label>
                                <input type="text" id="meetingTopic" placeholder="è¯·è¾“å…¥ä¼šè®®ä¸»é¢˜">
                            </div>
                        </div>

                        <div class="result-area" id="minutesResult">æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...</div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="generateMinutes()" id="generateBtn" disabled>
                                <span class="status-indicator status-ready"></span>ç”Ÿæˆä¼šè®®çºªè¦
                            </button>
                            <button class="btn" onclick="downloadMinutes()" id="downloadBtn" disabled>ä¸‹è½½çºªè¦</button>
                            <button class="btn btn-warning" onclick="clearMinutes()">æ¸…ç©ºç»“æœ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let processedAudioUrl = null;
        let isProcessing = false;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('audioFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            console.log('ä¼šè®®çºªè¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        async function uploadFile(file) {
            console.log('uploadFile å‡½æ•°è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file);
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/aac', 'audio/ogg', 'audio/flac', 'audio/x-ms-wma'];
            if (!allowedTypes.includes(file.type)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ã€‚');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°è¶…è¿‡100MBé™åˆ¶ï¼');
                return;
            }

            // å­˜å‚¨æ–‡ä»¶
            uploadedFile = file;
            processedAudioUrl = URL.createObjectURL(file);

            // æ›´æ–°UIæ˜¾ç¤º - æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadArea = document.getElementById('uploadArea');
            const uploadSuccess = document.getElementById('uploadSuccess');
            const resultArea = document.getElementById('minutesResult');
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            uploadArea.innerHTML = `
                <div class="upload-icon">â³</div>
                <div class="upload-text">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>
                <div class="file-info">
                    <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                    <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>ç±»å‹:</strong> ${file.type}
                </div>
            `;
            
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('audio_file', file);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                // ä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°UI
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</div>
                    <div class="file-info">
                        <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                        <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <strong>ç±»å‹:</strong> ${file.type}
                    </div>
                `;
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                uploadSuccess.style.display = 'block';
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ç°åœ¨å¯ä»¥ç›´æ¥ç”Ÿæˆä¼šè®®çºªè¦ã€‚';
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶ID
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id;
                
                // å¯ç”¨ç”Ÿæˆä¼šè®®çºªè¦æŒ‰é’®å’ŒéŸ³é¢‘å¤„ç†æŒ‰é’®
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('processBtn').disabled = false;
                
                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                if (audioPlayer) {
                    audioPlayer.src = processedAudioUrl;
                    audioPlayer.style.display = 'block';
                }

                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                
                // ä¸Šä¼ å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                uploadArea.innerHTML = `
                    <div class="upload-icon">âŒ</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ å¤±è´¥</div>
                    <div class="file-info">
                        <strong>é”™è¯¯:</strong> ${error.message}
                    </div>
                `;
                
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
                
                // ä¿æŒæŒ‰é’®ç¦ç”¨çŠ¶æ€
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('processBtn').disabled = true;
            }
        }

        // ASRä¼˜åŒ–é¢„å¤„ç†å‡½æ•°ï¼ˆç»Ÿä¸€å¤„ç†éŸ³é¢‘å¤„ç†å’Œæ‹¼æ¥éŸ³é¢‘çš„ä¼˜åŒ–ï¼‰
        async function optimizeAudioForASR(isSpliceMode = false) {
            console.log(`optimizeAudioForASR å‡½æ•°è¢«è°ƒç”¨ï¼Œæ¨¡å¼: ${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘å¤„ç†'}`);
            
            if (!uploadedFile) {
                throw new Error('æ²¡æœ‰å¯ä¼˜åŒ–çš„éŸ³é¢‘æ–‡ä»¶');
            }

            try {
                // æ ¹æ®æ¨¡å¼æ£€æŸ¥ä¸åŒçš„å¼€å…³çŠ¶æ€
                const enableOptimization = isSpliceMode 
                    ? document.getElementById('enableSpliceASROptimization').checked
                    : document.getElementById('enableASROptimization').checked;
                
                console.log(`${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘å¤„ç†'}ASRä¼˜åŒ–å¼€å…³çŠ¶æ€:`, enableOptimization);
                
                // æ ¹æ®æ¨¡å¼è·å–ä¸åŒçš„ä¼˜åŒ–å‚æ•°
                let asrOptimizationParams = {};
                if (enableOptimization) {
                    const settings = isSpliceMode ? window.spliceAsrSettings : window.asrSettings;
                    if (settings) {
                        asrOptimizationParams = {
                            normalize_audio: settings.normalizeAudio,
                            remove_silence: settings.removeSilence,
                            enhance_volume: settings.enhanceVolume,
                            compress_audio: settings.compressAudio,
                            target_sample_rate: parseInt(settings.targetSampleRate)
                        };
                    }
                }

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                formData.append('enable_asr_optimization', enableOptimization);
                formData.append('asr_optimization_params', JSON.stringify(asrOptimizationParams));

                const response = await fetch('/meeting_minutes/optimize_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘'}ä¼˜åŒ–å¤±è´¥`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || `${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘'}ä¼˜åŒ–å¤±è´¥`);
                }

                // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„ä¼˜åŒ–ç»“æœ
                console.log(`å‡†å¤‡æ˜¾ç¤º${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘å¤„ç†'}ä¼˜åŒ–ç»“æœ:`, result);
                if (isSpliceMode) {
                    displaySpliceOptimizationResult(result);
                } else {
                    displayOptimizationResult(result);
                }

                // åˆ›å»ºä¼˜åŒ–åçš„æ–‡ä»¶å¯¹è±¡
                const optimizedBlob = await fetch(result.optimized_file_url).then(r => r.blob());
                const optimizedFile = new File([optimizedBlob], result.optimized_filename, { type: 'audio/mpeg' });
                
                // æ›¿æ¢åŸå§‹æ–‡ä»¶
                uploadedFile = optimizedFile;
                
                console.log(`${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘'}ä¼˜åŒ–å®Œæˆ:`, result);
                
            } catch (error) {
                console.error(`${isSpliceMode ? 'æ‹¼æ¥éŸ³é¢‘' : 'éŸ³é¢‘'}ASRä¼˜åŒ–å¤±è´¥:`, error);
                throw error;
            }
        }

        // æ˜¾ç¤ºæ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–ç»“æœ
        function displaySpliceOptimizationResult(result) {
            console.log('displaySpliceOptimizationResult å‡½æ•°è¢«è°ƒç”¨ï¼Œå‚æ•°:', result);
            
            const resultDiv = document.getElementById('spliceOptimizationResult');
            console.log('spliceOptimizationResult å…ƒç´ :', resultDiv);
            
            if (!resultDiv) {
                console.error('æ‰¾ä¸åˆ° spliceOptimizationResult å…ƒç´ ');
                return;
            }

            const improvements = result.improvements || {};
            
            let html = `
                <div class="optimization-result">
                    <strong>âœ… æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–å®Œæˆ</strong>
                    <div class="optimization-improvements">
                        <div class="improvement-item">
                            <span>é‡‡æ ·ç‡:</span>
                            <span class="improvement-value">${improvements.sample_rate_before || 'N/A'} â†’ ${improvements.sample_rate_after || 'N/A'} Hz</span>
                        </div>
                        <div class="improvement-item">
                            <span>å£°é“:</span>
                            <span class="improvement-value">${improvements.channels_before || 'N/A'} â†’ ${improvements.channels_after || 'N/A'}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ¯”ç‰¹ç‡:</span>
                            <span class="improvement-value">${improvements.bitrate_before || 'N/A'} â†’ ${improvements.bitrate_after || 'N/A'} kbps</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ–‡ä»¶å¤§å°:</span>
                            <span class="improvement-value">${improvements.file_size_before || 'N/A'} â†’ ${improvements.file_size_after || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            console.log('æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–ç»“æœæ˜¾ç¤ºå®Œæˆ');
        }

        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœï¼ˆå…¼å®¹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼‰
        function displayOptimizationResults(optimizationInfo) {
            displayOptimizationResult({ optimization_info: optimizationInfo });
        }
        
        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        function displayOptimizationResult(result) {
            console.log('displayOptimizationResult å‡½æ•°è¢«è°ƒç”¨ï¼Œå‚æ•°:', result);
            
            const resultDiv = document.getElementById('optimizationResult');
            console.log('optimizationResult å…ƒç´ :', resultDiv);
            
            if (!resultDiv) {
                console.error('æ‰¾ä¸åˆ° optimizationResult å…ƒç´ ');
                return;
            }

            const improvements = result.improvements || {};
            
            let html = `
                <div class="optimization-result">
                    <strong>âœ… ASRä¼˜åŒ–å®Œæˆ</strong>
                    <div class="optimization-improvements">
                        <div class="improvement-item">
                            <span>é‡‡æ ·ç‡:</span>
                            <span class="improvement-value">${improvements.sample_rate_before || 'N/A'} â†’ ${improvements.sample_rate_after || 'N/A'} Hz</span>
                        </div>
                        <div class="improvement-item">
                            <span>å£°é“:</span>
                            <span class="improvement-value">${improvements.channels_before || 'N/A'} â†’ ${improvements.channels_after || 1}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ—¶é•¿å˜åŒ–:</span>
                            <span class="improvement-value">${improvements.duration_change || 'N/A'}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ–‡ä»¶å¤§å°:</span>
                            <span class="improvement-value">${formatFileSize(result.original_info?.file_size || 0)} â†’ ${formatFileSize(result.optimized_info?.file_size || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆ‡æ¢ä¼˜åŒ–é€‰é¡¹æ˜¾ç¤º/éšè—
        function toggleOptimizationOptions() {
            const checkbox = document.getElementById('enableASROptimization');
            const panel = document.getElementById('optimizationOptionsPanel');
            const result = document.getElementById('optimizationResult');
            
            if (checkbox.checked) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
                if (result) result.style.display = 'none';
            }
        }

        function clearFile() {
            uploadedFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
        }

        // éŸ³é¢‘å¤„ç†ç›¸å…³
        async function processAudio() {
            console.log('processAudio å‡½æ•°è¢«è°ƒç”¨');
            
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
            if (!uploadedFile.dify_file_id) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            isProcessing = true;
            document.getElementById('processBtn').disabled = true;
            const stopBtn = document.getElementById('stopBtn');
            if (stopBtn) {
                stopBtn.disabled = false;
                stopBtn.style.display = 'inline-block';
            }
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

            try {
                // ç¬¬ä¸€æ­¥ï¼šå…ˆè¿›è¡ŒéŸ³é¢‘å‰ªè¾‘
                document.getElementById('progressText').textContent = 'æ­£åœ¨å‰ªè¾‘éŸ³é¢‘æ–‡ä»¶...';
                
                // è·å–å¤„ç†å‚æ•°
                const startTime = parseFloat(document.getElementById('startTime').value) || 0;
                const endTime = parseFloat(document.getElementById('endTime').value) || null;
                const quality = document.getElementById('quality').value;
                const compress = quality !== 'high'; // é«˜è´¨é‡ä¸å‹ç¼©ï¼Œä¸­ç­‰å’Œä½è´¨é‡å‹ç¼©

                // è°ƒç”¨åç«¯éŸ³é¢‘å¤„ç†APIè¿›è¡Œå‰ªè¾‘
                const response = await fetch('/meeting_minutes/process_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: uploadedFile.original_file_id || uploadedFile.name.split('.')[0],
                        start_time: startTime,
                        end_time: endTime,
                        compress: compress
                    })
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘å‰ªè¾‘å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘å‰ªè¾‘å¤±è´¥');
                }

                // ä¿å­˜å‰ªè¾‘åçš„æ–‡ä»¶ä¿¡æ¯
                let finalProcessedFileId = result.processed_file_id;
                let finalProcessedFilename = result.processed_filename;
                let finalProcessedFileUrl = result.processed_file_url;

                // ç¬¬äºŒæ­¥ï¼šå¯¹å‰ªè¾‘åçš„æ–‡ä»¶è¿›è¡ŒASRä¼˜åŒ–ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                const enableOptimization = document.getElementById('enableASROptimization').checked;
                console.log('ASRä¼˜åŒ–å¼€å…³çŠ¶æ€:', enableOptimization);
                
                if (enableOptimization) {
                    console.log('å¼€å§‹å¯¹å‰ªè¾‘åçš„æ–‡ä»¶è¿›è¡ŒASRä¼˜åŒ–...');
                    document.getElementById('progressText').textContent = 'æ­£åœ¨å¯¹å‰ªè¾‘åçš„æ–‡ä»¶è¿›è¡ŒASRä¼˜åŒ–...';
                    
                    try {
                        // è·å–å‰ªè¾‘åçš„æ–‡ä»¶å¹¶åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¯¹è±¡
                        const clippedFileResponse = await fetch(finalProcessedFileUrl);
                        const clippedFileBlob = await clippedFileResponse.blob();
                        const tempClippedFile = new File([clippedFileBlob], finalProcessedFilename, { type: 'audio/mpeg' });
                        
                        // ä¸´æ—¶ä¿å­˜åŸå§‹æ–‡ä»¶
                        const originalUploadedFile = uploadedFile;
                        
                        // å°†å‰ªè¾‘åçš„æ–‡ä»¶è®¾ç½®ä¸ºå½“å‰æ–‡ä»¶ï¼Œä»¥ä¾¿optimizeAudioForASRå¤„ç†
                        uploadedFile = tempClippedFile;
                        
                        // è°ƒç”¨ç°æœ‰çš„ASRä¼˜åŒ–å‡½æ•°
                        await optimizeAudioForASR();
                        
                        // è·å–ä¼˜åŒ–åçš„æ–‡ä»¶ä¿¡æ¯
                        // optimizeAudioForASRå·²ç»æ›´æ–°äº†uploadedFileä¸ºä¼˜åŒ–åçš„æ–‡ä»¶
                        const optimizedFileBlob = uploadedFile;
                        
                        // åˆ›å»ºä¼˜åŒ–åæ–‡ä»¶çš„ä¸´æ—¶URLï¼ˆç”¨äºåç»­ä¸Šä¼ ï¼‰
                        finalProcessedFileUrl = URL.createObjectURL(optimizedFileBlob);
                        finalProcessedFilename = uploadedFile.name;
                        
                        // æ¢å¤åŸå§‹æ–‡ä»¶å¼•ç”¨
                        uploadedFile = originalUploadedFile;
                        
                        console.log('ASRä¼˜åŒ–å®Œæˆ');
                        document.getElementById('progressText').textContent = 'ASRä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨ä¸Šä¼ æœ€ç»ˆæ–‡ä»¶...';
                        
                    } catch (optimizationError) {
                        console.error('ASRä¼˜åŒ–å¤±è´¥:', optimizationError);
                        document.getElementById('progressText').textContent = 'ASRä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨å‰ªè¾‘åçš„æ–‡ä»¶...';
                        // ç»§ç»­å¤„ç†ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                    }
                }

                // ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ æœ€ç»ˆå¤„ç†åçš„æ–‡ä»¶åˆ°Dify
                document.getElementById('progressText').textContent = 'æ­£åœ¨ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶åˆ°Dify...';
                
                // è·å–æœ€ç»ˆå¤„ç†åçš„æ–‡ä»¶
                const finalFileResponse = await fetch(finalProcessedFileUrl);
                const finalFileBlob = await finalFileResponse.blob();
                
                // åˆ›å»ºFormDataä¸Šä¼ åˆ°Dify
                const uploadFormData = new FormData();
                uploadFormData.append('audio_file', finalFileBlob, finalProcessedFilename);

                const uploadResponse = await fetch('/meeting_minutes/upload_processed_audio', {
                    method: 'POST',
                    body: uploadFormData
                });

                if (!uploadResponse.ok) {
                    throw new Error('å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                // ä¿å­˜å¤„ç†åçš„æ–‡ä»¶ä¿¡æ¯
                uploadedFile.processed_file_id = finalProcessedFileId; // ä½¿ç”¨æœ¬åœ°å¤„ç†ç»“æœçš„ID
                uploadedFile.processed_filename = finalProcessedFilename;
                uploadedFile.processed_file_url = finalProcessedFileUrl; // ä¿å­˜å¤„ç†åéŸ³é¢‘æ–‡ä»¶çš„URL
                uploadedFile.duration = result.duration; // ä¿å­˜éŸ³é¢‘æ—¶é•¿
                uploadedFile.dify_processed_file_id = uploadResult.dify_file_id; // ä¿å­˜Difyä¸Šä¼ åçš„ID
                
                console.log('å¤„ç†å®Œæˆï¼Œæœ€ç»ˆDifyæ–‡ä»¶ID:', uploadResult.dify_file_id);
                finishProcessing();
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                document.getElementById('progressText').textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
                stopProcessing();
                alert('éŸ³é¢‘å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        function finishProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            const stopBtn = document.getElementById('stopBtn');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.style.display = 'none';
            }
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('progressText').textContent = 'å¤„ç†å®Œæˆï¼';
            
            setTimeout(() => {
                document.getElementById('processProgress').style.display = 'none';
            }, 2000);
            
            // å¦‚æœæœ‰å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶URLï¼Œæ›´æ–°éŸ³é¢‘æ’­æ”¾å™¨çš„src
            if (uploadedFile && uploadedFile.processed_file_url) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = uploadedFile.processed_file_url;
                processedAudioUrl = uploadedFile.processed_file_url;
                console.log('éŸ³é¢‘æ’­æ”¾å™¨å·²æ›´æ–°ä¸ºå¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶:', uploadedFile.processed_file_url);
            } else {
                processedAudioUrl = document.getElementById('audioPlayer').src;
            }
            
            console.log('éŸ³é¢‘å¤„ç†å®Œæˆ');
        }

        function previewAudio() {
            if (processedAudioUrl) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.currentTime = document.getElementById('startTime').value || 0;
                audioPlayer.play();
            }
        }

        function stopProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            const stopBtn = document.getElementById('stopBtn');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.style.display = 'none';
            }
            document.getElementById('processProgress').style.display = 'none';
        }

        // ä¼šè®®çºªè¦ç”Ÿæˆç›¸å…³
        async function generateMinutes() {
            if (!uploadedFile && !splicedAudioUrl) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹¼æ¥éŸ³é¢‘ï¼');
                return;
            }

            const participantCount = document.getElementById('participantCount').value;
            const meetingTopic = document.getElementById('meetingTopic').value;
            
            if (!participantCount) {
                alert('è¯·è¾“å…¥å‚ä¸äººæ•°ï¼');
                return;
            }

            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºæ‰€æœ‰å¯ç”¨çš„æ–‡ä»¶ID
            console.log('=== ç”Ÿæˆä¼šè®®çºªè¦ - æ–‡ä»¶IDè°ƒè¯•ä¿¡æ¯ ===');
            console.log('uploadedFileå¯¹è±¡:', uploadedFile);
            if (uploadedFile) {
                console.log('åŸå§‹æ–‡ä»¶ID (dify_file_id):', uploadedFile.dify_file_id);
                console.log('å¤„ç†åæ–‡ä»¶ID (dify_processed_file_id):', uploadedFile.dify_processed_file_id);
                console.log('åŸå§‹æ–‡ä»¶IDå¤‡ä»½ (original_file_id):', uploadedFile.original_file_id);
            }
            console.log('æ‹¼æ¥éŸ³é¢‘URL:', splicedAudioUrl);
            console.log('æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶å:', splicedAudioFilename);
            console.log('æ‹¼æ¥éŸ³é¢‘Dify ID:', splicedAudioDifyId);

            document.getElementById('generateBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');

            try {
                let fileId;
                
                // æ–‡ä»¶ä¼˜å…ˆçº§ï¼šæ‹¼æ¥æ–‡ä»¶ > å¤„ç†åæ–‡ä»¶ > åŸå§‹æ–‡ä»¶
                if (splicedAudioUrl && splicedAudioFilename && splicedAudioDifyId) {
                    // 1. ä¼˜å…ˆä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨å·²æœ‰çš„dify_file_id
                    fileId = splicedAudioDifyId;
                    resultArea.textContent = 'ä½¿ç”¨æ‹¼æ¥åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨æ‹¼æ¥åæ–‡ä»¶çš„Dify ID:', fileId);
                } else if (uploadedFile && uploadedFile.dify_processed_file_id) {
                    // 2. ä½¿ç”¨å¤„ç†åæ–‡ä»¶ä¸Šä¼ åˆ°Difyçš„ID
                    fileId = uploadedFile.dify_processed_file_id;
                    resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨å¤„ç†åæ–‡ä»¶çš„Dify ID:', fileId);
                } else if (uploadedFile && uploadedFile.dify_file_id) {
                    // 3. ä½¿ç”¨åŸå§‹æ–‡ä»¶ID
                    fileId = uploadedFile.dify_file_id;
                    resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                } else {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘æ–‡ä»¶');
                }

                // 2. è°ƒç”¨ç”Ÿæˆä¼šè®®çºªè¦çš„API
                const generateResp = await fetch('/meeting_minutes/generate_minutes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: fileId,
                        participants_count: parseInt(participantCount),
                        additional_info: meetingTopic || ''
                    })
                });

                if (!generateResp.ok) {
                    throw new Error('ä¼šè®®çºªè¦ç”Ÿæˆæ¥å£è°ƒç”¨å¤±è´¥');
                }

                // 3. å¤„ç†æµå¼å“åº”
                const reader = generateResp.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let result = '';

                resultArea.textContent = 'æ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦ï¼Œè¯·ç¨å€™...';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split(/\n\n/);
                    buffer = lines.pop();

                    for (let line of lines) {
                        if (line.startsWith('data:')) {
                            let content = line.slice(5).trim();
                            if (content.startsWith('[ERROR]')) {
                                throw new Error(content);
                            } else {
                                try {
                                    let obj = JSON.parse(content);
                                    
                                    // å¤„ç†Difyå·¥ä½œæµçš„å“åº”
                                    if (obj.event === 'message' && obj.answer) {
                                        result += obj.answer;
                                        resultArea.textContent = result;
                                    } else if (obj.event === 'message_end') {
                                        // ç”Ÿæˆå®Œæˆ
                                        document.getElementById('downloadBtn').disabled = false;
                                        console.log('ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆ');
                                        break;
                                    } else if (obj.event === 'error') {
                                        throw new Error(obj.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æå¤±è´¥çš„ç‰‡æ®µï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„JSON
                                    console.warn('JSONè§£æå¤±è´¥:', content);
                                }
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰è·å¾—ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                if (!result.trim()) {
                    resultArea.textContent = 'ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆï¼Œä½†æœªè·å¾—æœ‰æ•ˆå†…å®¹ã€‚è¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶è´¨é‡æˆ–é‡è¯•ã€‚';
                }

            } catch (error) {
                console.error('ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥:', error);
                resultArea.textContent = 'ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥: ' + error.message;
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function downloadMinutes() {
            const content = document.getElementById('minutesResult').textContent;
            if (!content || content.includes('ç­‰å¾…éŸ³é¢‘å¤„ç†')) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¼šè®®çºªè¦ï¼');
                return;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¼šè®®çºªè¦_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearMinutes() {
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
        }

        function clearFile() {
            // é‡ç½®æ‰€æœ‰æ–‡ä»¶ç›¸å…³å˜é‡
            uploadedFile = null;
            processedAudioUrl = null;
            isProcessing = false;
            
            // é‡ç½®éŸ³é¢‘æ‹¼æ¥ç›¸å…³å˜é‡
            spliceSegments = [];
            splicedAudioUrl = null;
            splicedAudioFilename = null;
            splicedAudioDifyId = null;
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">â˜ï¸</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="file-info">
                    æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                    æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                </div>
            `;
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('audioFile').value = '';
            const localAudioInput = document.getElementById('localAudioFiles');
            if (localAudioInput) {
                localAudioInput.value = '';
            }
            
            // éšè—æˆåŠŸæ¶ˆæ¯
            document.getElementById('uploadSuccess').style.display = 'none';
            
            // é‡ç½®è¿›åº¦æ˜¾ç¤º
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = 'å¤„ç†ä¸­...';
                progressText.style.display = 'none';
            }
            
            const spliceProgressText = document.getElementById('spliceProgressText');
            if (spliceProgressText) {
                spliceProgressText.textContent = 'æ‹¼æ¥ä¸­...';
            }
            
            const progressContainer = document.getElementById('spliceProgress');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            // é‡ç½®åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopBtn');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.style.display = 'none';
            }
            
            // éšè—ASRä¼˜åŒ–å®Œæˆé¢æ¿
            const optimizationResult = document.getElementById('optimizationResult');
            if (optimizationResult) {
                optimizationResult.style.display = 'none';
                optimizationResult.innerHTML = '';
            }
            
            // éšè—æ‹¼æ¥ASRä¼˜åŒ–ç»“æœé¢æ¿
            const spliceOptimizationResult = document.getElementById('spliceOptimizationResult');
            if (spliceOptimizationResult) {
                spliceOptimizationResult.style.display = 'none';
                spliceOptimizationResult.innerHTML = '';
            }
            
            // é‡ç½®ASRä¼˜åŒ–è®¾ç½®
            const enableASROptimization = document.getElementById('enableASROptimization');
            if (enableASROptimization) {
                enableASROptimization.checked = false;
            }
            
            const enableSpliceASROptimization = document.getElementById('enableSpliceASROptimization');
            if (enableSpliceASROptimization) {
                enableSpliceASROptimization.checked = false;
            }
            
            // é‡ç½®ä¼˜åŒ–é€‰é¡¹é¢æ¿æ˜¾ç¤º
            const optimizationOptionsPanel = document.getElementById('optimizationOptionsPanel');
            if (optimizationOptionsPanel) {
                optimizationOptionsPanel.style.display = 'none';
            }
            
            // ç¦ç”¨ç›¸å…³æŒ‰é’®
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€æŒ‡ç¤ºå™¨
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                const statusIndicator = processBtn.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator status-ready';
                }
            }
            
            // éšè—éŸ³é¢‘æ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            
            // éšè—æ‹¼æ¥éŸ³é¢‘æ’­æ”¾å™¨
            const spliceAudioPlayer = document.getElementById('spliceAudioPlayer');
            if (spliceAudioPlayer) {
                spliceAudioPlayer.style.display = 'none';
                spliceAudioPlayer.src = '';
            }
            
            // æ¸…ç©ºæ‹¼æ¥åˆ—è¡¨æ˜¾ç¤º
            const spliceFilesList = document.getElementById('spliceFilesList');
            if (spliceFilesList) {
                spliceFilesList.innerHTML = '<div class="empty-message">æš‚æ— æ–‡ä»¶ï¼Œè¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æˆ–æ·»åŠ æœ¬åœ°æ–‡ä»¶</div>';
            }
            
            // éšè—æ‹¼æ¥é¢„è§ˆ
            const splicePreview = document.getElementById('splicePreview');
            if (splicePreview) {
                splicePreview.style.display = 'none';
            }
            
            // æ›´æ–°æ‹¼æ¥æŒ‰é’®çŠ¶æ€
            updateSpliceButtons();
            
            // é‡ç½®ä¼šè®®çºªè¦ç»“æœ
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
            
            // é‡ç½®è¡¨å•è¾“å…¥
            const participantCount = document.getElementById('participantCount');
            if (participantCount) {
                participantCount.value = '';
            }
            
            const meetingTopic = document.getElementById('meetingTopic');
            if (meetingTopic) {
                meetingTopic.value = '';
            }
            
            // é‡ç½®éŸ³é¢‘å¤„ç†å‚æ•°
            const startTime = document.getElementById('startTime');
            if (startTime) {
                startTime.value = '';
            }
            
            const endTime = document.getElementById('endTime');
            if (endTime) {
                endTime.value = '';
            }
            
            const quality = document.getElementById('quality');
            if (quality) {
                quality.value = 'medium';
            }
            
            console.log('æ‰€æœ‰çŠ¶æ€å·²å®Œå…¨æ¸…é™¤ï¼Œç³»ç»Ÿå·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
        }

        // éŸ³é¢‘æ‹¼æ¥ç›¸å…³å˜é‡å’Œå‡½æ•°
        let spliceSegments = [];
        let splicedAudioUrl = null;
        let splicedAudioFilename = null;
        let splicedAudioDifyId = null; // å­˜å‚¨æ‹¼æ¥éŸ³é¢‘çš„dify_file_id

        // å¤„ç†æœ¬åœ°éŸ³é¢‘æ–‡ä»¶é€‰æ‹©
        async function handleLocalAudioFiles(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const progressText = document.getElementById('spliceProgressText') || createProgressElement();
            const progressContainer = document.getElementById('spliceProgress') || createProgressContainer();
            
            progressContainer.style.display = 'block';
            progressText.textContent = 'æ­£åœ¨ä¸Šä¼ æœ¬åœ°éŸ³é¢‘æ–‡ä»¶...';

            try {
                // åˆ›å»ºFormDataä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                const validFiles = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('audio/')) {
                        alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ï¼`);
                        continue;
                    }

                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBï¼‰
                    const maxSize = 50 * 1024 * 1024; // 50MB
                    if (file.size > maxSize) {
                        alert(`æ–‡ä»¶ "${file.name}" è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„éŸ³é¢‘æ–‡ä»¶ï¼`);
                        continue;
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªæ–‡ä»¶
                    const existingSegment = spliceSegments.find(seg => seg.filename === file.name && seg.type === 'local');
                    if (existingSegment) {
                        alert(`æ–‡ä»¶ "${file.name}" å·²åœ¨æ‹¼æ¥åˆ—è¡¨ä¸­ï¼`);
                        continue;
                    }
                    
                    formData.append('audio_files', file);
                    validFiles.push(file);
                }
                
                if (validFiles.length === 0) {
                    progressContainer.style.display = 'none';
                    return;
                }
                
                // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
                const response = await fetch('/meeting_minutes/upload_local_audio', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
                
                // æ·»åŠ ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶åˆ°æ‹¼æ¥åˆ—è¡¨
                result.uploaded_files.forEach(uploadedFile => {
                    const segment = {
                        file_id: uploadedFile.file_id,
                        filename: uploadedFile.original_filename,
                        duration: uploadedFile.audio_info.duration || 0,
                        file_url: `/meeting_minutes/static/temp/${uploadedFile.server_filename}`,
                        server_filename: uploadedFile.server_filename,
                        type: 'local' // æ ‡è®°ä¸ºæœ¬åœ°æ–‡ä»¶
                    };

                    spliceSegments.push(segment);
                });
                
                updateSpliceList();
                updateSpliceButtons();
                
                progressText.textContent = `æˆåŠŸä¸Šä¼  ${result.uploaded_files.length} ä¸ªæ–‡ä»¶ï¼`;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                progressText.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
            event.target.value = '';
        }
        
        // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºå…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        function createProgressElement() {
            let progressText = document.getElementById('spliceProgressText');
            if (!progressText) {
                progressText = document.createElement('div');
                progressText.id = 'spliceProgressText';
                progressText.textContent = 'å¤„ç†ä¸­...';
                document.body.appendChild(progressText);
            }
            return progressText;
        }
        
        function createProgressContainer() {
            let progressContainer = document.getElementById('spliceProgress');
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = 'spliceProgress';
                progressContainer.style.display = 'none';
                progressContainer.appendChild(createProgressElement());
                document.body.appendChild(progressContainer);
            }
            return progressContainer;
        }

        // æ·»åŠ éŸ³é¢‘ç‰‡æ®µåˆ°æ‹¼æ¥åˆ—è¡¨
        function addAudioSegment() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // ç¡®å®šä½¿ç”¨çš„æ–‡ä»¶IDå’Œç›¸å…³ä¿¡æ¯
            let fileId, filename, fileUrl;
            
            if (uploadedFile.processed_file_id) {
                // ä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶
                fileId = uploadedFile.processed_file_id;
                filename = uploadedFile.processed_filename || `${uploadedFile.processed_file_id}.mp3`;
                // æ„å»ºå®Œæ•´çš„URLç”¨äºé¢„è§ˆ
                fileUrl = window.location.origin + uploadedFile.processed_file_url;
            } else if (uploadedFile.dify_file_id) {
                // ä½¿ç”¨åŸå§‹æ–‡ä»¶
                fileId = uploadedFile.dify_file_id;
                filename = uploadedFile.name;
                fileUrl = URL.createObjectURL(uploadedFile);
            } else {
                alert('è¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªç‰‡æ®µ
            const existingSegment = spliceSegments.find(seg => seg.file_id === fileId);
            if (existingSegment) {
                alert('è¯¥éŸ³é¢‘ç‰‡æ®µå·²åœ¨æ‹¼æ¥åˆ—è¡¨ä¸­ï¼');
                return;
            }

            // æ·»åŠ åˆ°æ‹¼æ¥åˆ—è¡¨
            const segment = {
                file_id: fileId,
                filename: filename,
                duration: uploadedFile.duration || 0,
                url: fileUrl
            };

            spliceSegments.push(segment);
            updateSpliceList();
            updateSpliceButtons();
            
            console.log('æ·»åŠ éŸ³é¢‘ç‰‡æ®µ:', segment);
        }

        // æ›´æ–°æ‹¼æ¥åˆ—è¡¨æ˜¾ç¤º
        function updateSpliceList() {
            const listContainer = document.getElementById('spliceFilesList');
            
            if (spliceSegments.length === 0) {
                listContainer.innerHTML = '<div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–é€‰æ‹©æœ¬åœ°æ–‡ä»¶</div>';
                return;
            }

            let html = '';
            spliceSegments.forEach((segment, index) => {
                // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡è¯†
                const typeIcon = segment.type === 'local' ? 'ğŸ“' : 'ğŸµ';
                const typeLabel = segment.type === 'local' ? 'æœ¬åœ°æ–‡ä»¶' : 'å·²å¤„ç†';
                
                html += `
                    <div class="splice-item" data-index="${index}">
                        <div class="splice-item-info">
                            <div class="splice-item-name">
                                ${typeIcon} ${segment.filename}
                                <span class="file-type-label">(${typeLabel})</span>
                            </div>
                            <div class="splice-item-duration">æ—¶é•¿: ${formatDuration(segment.duration)}</div>
                        </div>
                        <div class="splice-item-controls">
                            <button class="move-up" onclick="moveSpliceItem(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                            <button class="move-down" onclick="moveSpliceItem(${index}, 1)" ${index === spliceSegments.length - 1 ? 'disabled' : ''}>â†“</button>
                            <button class="remove-item" onclick="removeSpliceItem(${index})">Ã—</button>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // ç§»åŠ¨æ‹¼æ¥é¡¹ç›®
         function moveSpliceItem(index, direction) {
             const newIndex = index + direction;
             if (newIndex < 0 || newIndex >= spliceSegments.length) return;

             // äº¤æ¢ä½ç½®
             [spliceSegments[index], spliceSegments[newIndex]] = [spliceSegments[newIndex], spliceSegments[index]];
             updateSpliceList();
         }

         // åˆ é™¤æ‹¼æ¥é¡¹ç›®
        function removeSpliceItem(index) {
            const segment = spliceSegments[index];
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œéœ€è¦æ¸…ç†URLå¯¹è±¡
            if (segment && segment.type === 'local' && segment.file_url) {
                URL.revokeObjectURL(segment.file_url);
            }
            
            spliceSegments.splice(index, 1);
            updateSpliceList();
            updateSpliceButtons();
        }

         // æ›´æ–°æ‹¼æ¥ç›¸å…³æŒ‰é’®çŠ¶æ€
         function updateSpliceButtons() {
             const hasSegments = spliceSegments.length > 0;
             document.getElementById('spliceBtn').disabled = !hasSegments;
             document.getElementById('previewSpliceBtn').disabled = !hasSegments;
         }

         // å¼€å§‹æ‹¼æ¥éŸ³é¢‘
        async function spliceAudio() {
            if (spliceSegments.length === 0) {
                alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                return;
            }

            document.getElementById('spliceBtn').disabled = true;
            document.getElementById('spliceProgress').style.display = 'block';
            document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨å‡†å¤‡æ‹¼æ¥...';

            try {
                // ç¬¬ä¸€æ­¥ï¼šæ‹¼æ¥éŸ³é¢‘æ–‡ä»¶
                document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨æ‹¼æ¥éŸ³é¢‘...';
                
                const spliceResponse = await fetch('/meeting_minutes/splice_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segments: spliceSegments.map(seg => ({
                            file_id: seg.file_id,
                            filename: seg.filename
                        }))
                    })
                });

                if (!spliceResponse.ok) {
                    throw new Error('éŸ³é¢‘æ‹¼æ¥å¤±è´¥');
                }

                const spliceResult = await spliceResponse.json();
                if (!spliceResult.success) {
                    throw new Error(spliceResult.error || 'æ‹¼æ¥å¤±è´¥');
                }

                // æ„å»ºå®Œæ•´çš„URL
                let fullUrl = window.location.origin + spliceResult.spliced_file_url;
                splicedAudioUrl = fullUrl;
                splicedAudioFilename = spliceResult.spliced_filename;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewContainer = document.getElementById('splicePreview');
                const audioPlayer = document.getElementById('spliceAudioPlayer');
                audioPlayer.src = fullUrl;
                previewContainer.style.display = 'block';
                
                // ç¬¬äºŒæ­¥ï¼šASRä¼˜åŒ–å¤„ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                const enableOptimization = document.getElementById('enableSpliceASROptimization').checked;
                console.log('æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–å¼€å…³çŠ¶æ€:', enableOptimization);
                
                if (enableOptimization) {
                    document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨è¿›è¡ŒASRä¼˜åŒ–...';
                    
                    try {
                        // è·å–æ‹¼æ¥åçš„æ–‡ä»¶å¹¶åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¯¹è±¡
                        const splicedFileResponse = await fetch(fullUrl);
                        const splicedFileBlob = await splicedFileResponse.blob();
                        const tempSplicedFile = new File([splicedFileBlob], spliceResult.spliced_filename, { type: 'audio/mpeg' });
                        
                        // ä¸´æ—¶ä¿å­˜åŸå§‹æ–‡ä»¶
                        const originalUploadedFile = uploadedFile;
                        
                        // å°†æ‹¼æ¥åçš„æ–‡ä»¶è®¾ç½®ä¸ºå½“å‰æ–‡ä»¶ï¼Œä»¥ä¾¿optimizeAudioForASRå¤„ç†
                        uploadedFile = tempSplicedFile;
                        
                        // è°ƒç”¨æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–å‡½æ•°
                        await optimizeAudioForASR(true);
                        
                        // è·å–ä¼˜åŒ–åçš„æ–‡ä»¶ä¿¡æ¯
                        const optimizedFileBlob = uploadedFile;
                        
                        // åˆ›å»ºä¼˜åŒ–åæ–‡ä»¶çš„ä¸´æ—¶URLï¼ˆç”¨äºåç»­ä¸Šä¼ ï¼‰
                        fullUrl = URL.createObjectURL(optimizedFileBlob);
                        spliceResult.spliced_filename = uploadedFile.name;
                        
                        // æ¢å¤åŸå§‹æ–‡ä»¶å¼•ç”¨
                        uploadedFile = originalUploadedFile;
                        
                        // æ›´æ–°é¢„è§ˆæ’­æ”¾å™¨
                        audioPlayer.src = fullUrl;
                        
                        console.log('ASRä¼˜åŒ–å®Œæˆ');
                        
                    } catch (optimizationError) {
                        console.error('ASRä¼˜åŒ–å¤±è´¥:', optimizationError);
                        document.getElementById('spliceProgressText').textContent = 'ASRä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶...';
                        // ç»§ç»­å¤„ç†ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                    }
                } else {
                    console.log('ASRä¼˜åŒ–æœªå¯ç”¨ï¼Œè·³è¿‡ä¼˜åŒ–æ­¥éª¤');
                }
                
                // åˆ›å»ºæœ€ç»ˆçš„uploadedFileå¯¹è±¡ç”¨äºä¸Šä¼ 
                uploadedFile = {
                    filename: spliceResult.spliced_filename,
                    url: fullUrl
                };
                
                // ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ åˆ°Dify
                document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨ä¸Šä¼ åˆ°Dify...';
                
                // è·å–æ‹¼æ¥åçš„éŸ³é¢‘æ–‡ä»¶
                const audioResponse = await fetch(fullUrl);
                const audioBlob = await audioResponse.blob();
                
                // åˆ›å»ºFormDataä¸Šä¼ æ–‡ä»¶
                const uploadFormData = new FormData();
                uploadFormData.append('audio_file', audioBlob, spliceResult.spliced_filename);
                
                const uploadResponse = await fetch('/meeting_minutes/upload_processed_audio', {
                    method: 'POST',
                    body: uploadFormData
                });

                if (!uploadResponse.ok) {
                    throw new Error('ä¸Šä¼ åˆ°Difyå¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'ä¸Šä¼ åˆ°Difyå¤±è´¥');
                }

                // æ›´æ–°uploadedFileå¯¹è±¡ï¼ŒåŒ…å«dify_file_id
                uploadedFile.dify_file_id = uploadResult.dify_file_id;
                
                // åŒæ—¶æ›´æ–°å…¨å±€å˜é‡ï¼Œä¾›generateMinuteså‡½æ•°ä½¿ç”¨
                splicedAudioDifyId = uploadResult.dify_file_id;
                
                document.getElementById('spliceProgressText').textContent = 'å¤„ç†å®Œæˆï¼';
                document.getElementById('downloadSpliceBtn').disabled = false;
                
                // å¯ç”¨ç”Ÿæˆä¼šè®®çºªè¦æŒ‰é’®
                document.getElementById('generateBtn').disabled = false;
                
                // å…ˆä¿å­˜å½“å‰ä¼šè®®çºªè¦å†…å®¹ç”¨äºæ£€æŸ¥
                const minutesResult = document.getElementById('minutesResult');
                const currentContent = minutesResult ? minutesResult.textContent : '';
                
                // æ›´æ–°ä¼šè®®çºªè¦æ˜¾ç¤ºæ¡†çš„æç¤ºæ–‡æœ¬
                document.getElementById('minutesResult').textContent = 'éŸ³é¢‘æ‹¼æ¥å®Œæˆï¼Œå¯ä»¥ç”Ÿæˆä¼šè®®çºªè¦äº†ï¼';
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å®é™…çš„ä¼šè®®çºªè¦å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™å¯ç”¨ä¸‹è½½çºªè¦æŒ‰é’®
                if (currentContent && 
                    !currentContent.includes('æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦') &&
                    !currentContent.includes('éŸ³é¢‘æ‹¼æ¥å®Œæˆï¼Œå¯ä»¥ç”Ÿæˆä¼šè®®çºªè¦äº†') &&
                    currentContent.trim() !== '') {
                    document.getElementById('downloadBtn').disabled = false;
                }
                
                setTimeout(() => {
                    document.getElementById('spliceProgress').style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                document.getElementById('spliceProgressText').textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
                
                // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿç¦ç”¨ä¸‹è½½æŒ‰é’®
                document.getElementById('downloadSpliceBtn').disabled = true;
                document.getElementById('generateBtn').disabled = true;
                
                setTimeout(() => {
                    document.getElementById('spliceProgress').style.display = 'none';
                }, 3000);
            } finally {
                document.getElementById('spliceBtn').disabled = false;
            }
        }

         // é¢„è§ˆæ‹¼æ¥æ•ˆæœ
         async function previewSplice() {
             if (spliceSegments.length === 0) {
                 alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                 return;
             }

             // å¦‚æœå·²ç»æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œç›´æ¥é¢„è§ˆ
             if (splicedAudioUrl) {
                 const previewContainer = document.getElementById('splicePreview');
                 const audioPlayer = document.getElementById('spliceAudioPlayer');
                 audioPlayer.src = splicedAudioUrl;
                 previewContainer.style.display = 'block';
                 audioPlayer.play();
                 return;
             }

             // å¦‚æœæ²¡æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œå…ˆæ‰§è¡Œæ‹¼æ¥
             try {
                 document.getElementById('previewSpliceBtn').disabled = true;
                 document.getElementById('previewSpliceBtn').textContent = 'æ­£åœ¨æ‹¼æ¥...';
                 
                 await spliceAudio();
                 
                 // æ‹¼æ¥å®Œæˆåé¢„è§ˆ
                 if (splicedAudioUrl) {
                     const previewContainer = document.getElementById('splicePreview');
                     const audioPlayer = document.getElementById('spliceAudioPlayer');
                     audioPlayer.src = splicedAudioUrl;
                     previewContainer.style.display = 'block';
                     audioPlayer.play();
                 }
             } catch (error) {
                 console.error('é¢„è§ˆæ‹¼æ¥å¤±è´¥:', error);
                 alert('é¢„è§ˆæ‹¼æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
             } finally {
                 document.getElementById('previewSpliceBtn').disabled = false;
                 document.getElementById('previewSpliceBtn').textContent = 'é¢„è§ˆæ‹¼æ¥';
             }
         }

         // ä¸‹è½½æ‹¼æ¥åçš„éŸ³é¢‘
         function downloadSplicedAudio() {
             if (!splicedAudioUrl) {
                 alert('è¯·å…ˆæ‹¼æ¥éŸ³é¢‘ï¼');
                 return;
             }

             const a = document.createElement('a');
             a.href = splicedAudioUrl;
             a.download = splicedAudioFilename || `æ‹¼æ¥éŸ³é¢‘_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.mp3`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
         }

         // æ¸…ç©ºæ‹¼æ¥åˆ—è¡¨
        function clearSpliceList() {
            // æ¸…ç†æ‰€æœ‰æœ¬åœ°æ–‡ä»¶çš„URLå¯¹è±¡
            spliceSegments.forEach(segment => {
                if (segment.type === 'local' && segment.file_url) {
                    URL.revokeObjectURL(segment.file_url);
                }
            });
            
            spliceSegments = [];
            splicedAudioUrl = null;
            splicedAudioFilename = null;
            updateSpliceList();
            updateSpliceButtons();
            document.getElementById('splicePreview').style.display = 'none';
            document.getElementById('downloadSpliceBtn').disabled = true;
            
            // æ¸…ç©ºASRä¼˜åŒ–ç»“æœé¢æ¿
            const spliceOptimizationResult = document.getElementById('spliceOptimizationResult');
            if (spliceOptimizationResult) {
                spliceOptimizationResult.style.display = 'none';
                spliceOptimizationResult.innerHTML = '';
            }
        }

         // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
         function formatDuration(seconds) {
             if (!seconds || seconds === 0) return 'æœªçŸ¥';
             const minutes = Math.floor(seconds / 60);
             const remainingSeconds = Math.floor(seconds % 60);
             return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
         }

         // ASRä¼˜åŒ–æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
         function openAsrModal() {
             const modal = document.getElementById('asrOptimizationModal');
             modal.classList.add('show');
             modal.style.display = 'flex';
         }

         function closeAsrModal() {
             const modal = document.getElementById('asrOptimizationModal');
             modal.classList.add('hide');
             modal.classList.remove('show');
             setTimeout(() => {
                 modal.classList.remove('hide');
             }, 300);
         }

         function applyAsrSettings() {
             // è·å–æ‰€æœ‰è®¾ç½®å€¼
             const settings = {
                 normalizeAudio: document.getElementById('normalizeAudio').checked,
                 removeSilence: document.getElementById('removeSilence').checked,
                 enhanceVolume: document.getElementById('enhanceVolume').checked,
                 compressAudio: document.getElementById('compressAudio').checked,
                 targetSampleRate: document.getElementById('targetSampleRate').value
             };

             // æ›´æ–°ä¸»é¡µé¢çš„ASRä¼˜åŒ–checkboxçŠ¶æ€
             const enableASROptimization = document.getElementById('enableASROptimization');
             const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                      settings.enhanceVolume || settings.compressAudio;
             enableASROptimization.checked = hasAnyOptimization;

             // ä¿å­˜è®¾ç½®åˆ°å…¨å±€å˜é‡æˆ–localStorage
             window.asrSettings = settings;
             localStorage.setItem('asrSettings', JSON.stringify(settings));

             closeAsrModal();
             
             // æ˜¾ç¤ºåº”ç”¨æˆåŠŸæç¤º
             const helpText = document.querySelector('#asrOptimizationTrigger + .help-text');
             const originalText = helpText.textContent;
             helpText.textContent = 'âœ“ è®¾ç½®å·²åº”ç”¨';
             helpText.style.color = '#28a745';
             setTimeout(() => {
                 helpText.textContent = originalText;
                 helpText.style.color = '';
             }, 2000);
         }

         // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
         document.addEventListener('DOMContentLoaded', function() {
             // ä¸ºASRä¼˜åŒ–è§¦å‘å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
             document.getElementById('asrOptimizationTrigger').addEventListener('click', function(e) {
                 e.preventDefault();
                 openAsrModal();
             });

             // ä¸ºæ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è§¦å‘å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
             const spliceAsrTrigger = document.getElementById('spliceAsrOptimizationTrigger');
             if (spliceAsrTrigger) {
                 spliceAsrTrigger.addEventListener('click', function(e) {
                     // å¦‚æœç‚¹å‡»çš„æ˜¯checkboxï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
                     if (e.target.type !== 'checkbox') {
                         e.preventDefault();
                         e.stopPropagation();
                         openSpliceAsrModal();
                     }
                 });
             }
             
             // ä¸ºæ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–å¸®åŠ©æ–‡æœ¬æ·»åŠ ç‚¹å‡»äº‹ä»¶
             const spliceHelpText = document.querySelector('#spliceAsrOptimizationTrigger').parentElement.nextElementSibling;
             if (spliceHelpText && spliceHelpText.classList.contains('help-text')) {
                 spliceHelpText.addEventListener('click', function(e) {
                     e.preventDefault();
                     e.stopPropagation();
                     openSpliceAsrModal();
                 });
                 // æ·»åŠ é¼ æ ‡æ‚¬åœæ ·å¼
                 spliceHelpText.style.cursor = 'pointer';
                 spliceHelpText.style.color = '#007bff';
             }

             // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
             document.getElementById('asrOptimizationModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     closeAsrModal();
                 }
             });

             // ç‚¹å‡»æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
             document.getElementById('spliceAsrOptimizationModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     closeSpliceAsrModal();
                 }
             });

             // åŠ è½½ä¿å­˜çš„è®¾ç½®
             const savedSettings = localStorage.getItem('asrSettings');
             if (savedSettings) {
                 const settings = JSON.parse(savedSettings);
                 document.getElementById('normalizeAudio').checked = settings.normalizeAudio;
                 document.getElementById('removeSilence').checked = settings.removeSilence;
                 document.getElementById('enhanceVolume').checked = settings.enhanceVolume;
                 document.getElementById('compressAudio').checked = settings.compressAudio;
                 document.getElementById('targetSampleRate').value = settings.targetSampleRate;
                 
                 // æ›´æ–°ä¸»é¡µé¢checkboxçŠ¶æ€
                 const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                          settings.enhanceVolume || settings.compressAudio;
                 document.getElementById('enableASROptimization').checked = hasAnyOptimization;
             }

             // åŠ è½½æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–ä¿å­˜çš„è®¾ç½®
             const savedSpliceSettings = localStorage.getItem('spliceAsrSettings');
             if (savedSpliceSettings) {
                 const settings = JSON.parse(savedSpliceSettings);
                 document.getElementById('spliceNormalizeAudio').checked = settings.normalizeAudio;
                 document.getElementById('spliceRemoveSilence').checked = settings.removeSilence;
                 document.getElementById('spliceEnhanceVolume').checked = settings.enhanceVolume;
                 document.getElementById('spliceCompressAudio').checked = settings.compressAudio;
                 document.getElementById('spliceTargetSampleRate').value = settings.targetSampleRate;
                 
                 // æ›´æ–°ä¸»é¡µé¢checkboxçŠ¶æ€
                 const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                          settings.enhanceVolume || settings.compressAudio;
                 document.getElementById('enableSpliceASROptimization').checked = hasAnyOptimization;
             }
         });
     </script>

     <!-- ASRä¼˜åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
     <div id="asrOptimizationModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>ğŸ¯ ASRä¼˜åŒ–è®¾ç½®</h3>
                 <span class="modal-close" onclick="closeAsrModal()">&times;</span>
             </div>
             <div class="modal-body">
                 <div class="optimization-options">
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="normalizeAudio">
                             éŸ³é¢‘æ ‡å‡†åŒ–
                         </label>
                         <span class="option-desc">å¢å¼ºéŸ³é‡ï¼Œæé«˜ä¿¡å™ªæ¯”</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="removeSilence">
                             å»é™¤é™éŸ³æ®µ
                         </label>
                         <span class="option-desc">ç§»é™¤é•¿æ—¶é—´é™éŸ³ï¼Œæé«˜å¤„ç†æ•ˆç‡</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="enhanceVolume">
                             éŸ³é‡å¢å¼º
                         </label>
                         <span class="option-desc">è‡ªåŠ¨è°ƒæ•´éŸ³é‡åˆ°æœ€ä½³æ°´å¹³</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="compressAudio">
                             åŠ¨æ€èŒƒå›´å‹ç¼©
                         </label>
                         <span class="option-desc">å¹³è¡¡éŸ³é‡å·®å¼‚ï¼Œæ”¹å–„è¯†åˆ«æ•ˆæœ</span>
                     </div>
                     <div class="option-row">
                         <label>ç›®æ ‡é‡‡æ ·ç‡:</label>
                         <select id="targetSampleRate">
                             <option value="16000">16kHz (æ ‡å‡†)</option>
                             <option value="24000" selected>24kHz (æ¨è)</option>
                             <option value="48000">48kHz (é«˜è´¨é‡)</option>
                         </select>
                         <span class="option-desc">24kHzä¸ºASRæœ€ä½³é‡‡æ ·ç‡</span>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-success" onclick="applyAsrSettings()">åº”ç”¨è®¾ç½®</button>
                 <button class="btn" onclick="closeAsrModal()">å–æ¶ˆ</button>
             </div>
         </div>
     </div>

     <!-- æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
     <div id="spliceAsrOptimizationModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>ğŸ¯ æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è®¾ç½®</h3>
                 <span class="modal-close" onclick="closeSpliceAsrModal()">&times;</span>
             </div>
             <div class="modal-body">
                 <div class="optimization-options">
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceNormalizeAudio">
                             éŸ³é¢‘æ ‡å‡†åŒ–
                         </label>
                         <span class="option-desc">å¢å¼ºéŸ³é‡ï¼Œæé«˜ä¿¡å™ªæ¯”</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceRemoveSilence">
                             å»é™¤é™éŸ³æ®µ
                         </label>
                         <span class="option-desc">ç§»é™¤é•¿æ—¶é—´é™éŸ³ï¼Œæé«˜å¤„ç†æ•ˆç‡</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceEnhanceVolume">
                             éŸ³é‡å¢å¼º
                         </label>
                         <span class="option-desc">è‡ªåŠ¨è°ƒæ•´éŸ³é‡åˆ°æœ€ä½³æ°´å¹³</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceCompressAudio">
                             åŠ¨æ€èŒƒå›´å‹ç¼©
                         </label>
                         <span class="option-desc">å¹³è¡¡éŸ³é‡å·®å¼‚ï¼Œæ”¹å–„è¯†åˆ«æ•ˆæœ</span>
                     </div>
                     <div class="option-row">
                         <label>ç›®æ ‡é‡‡æ ·ç‡:</label>
                         <select id="spliceTargetSampleRate">
                             <option value="16000">16kHz (æ ‡å‡†)</option>
                             <option value="24000" selected>24kHz (æ¨è)</option>
                             <option value="48000">48kHz (é«˜è´¨é‡)</option>
                         </select>
                         <span class="option-desc">24kHzä¸ºASRæœ€ä½³é‡‡æ ·ç‡</span>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-success" onclick="applySpliceAsrSettings()">åº”ç”¨è®¾ç½®</button>
                 <button class="btn" onclick="closeSpliceAsrModal()">å–æ¶ˆ</button>
             </div>
         </div>
     </div>

 </body>
 </html>
