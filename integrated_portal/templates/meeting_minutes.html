<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®çºªè¦ç³»ç»Ÿ - ç»Ÿä¸€é—¨æˆ·ç³»ç»Ÿ</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* æ–°çš„æµç¨‹å¼å¸ƒå±€ */
        .workflow-container {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .workflow-step {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: fit-content;
            min-height: 600px; /* è®¾ç½®ç»Ÿä¸€çš„æœ€å°é«˜åº¦ */
        }

        .workflow-step:hover {
            border-color: #007bff;
            box-shadow: 0 4px 16px rgba(0,123,255,0.1);
        }

        .step-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 10px 15px;
            margin: -15px -15px 15px -15px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .step-number {
            background: rgba(255,255,255,0.2);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .step-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }

        .step-main {
            flex: 2;
        }

        .step-controls {
            flex: 1;
            min-width: 300px;
        }

        /* éŸ³é¢‘ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #fafafa, #f0f0f0);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: linear-gradient(135deg, #e6f3ff, #cce7ff);
        }

        .upload-icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #333;
            font-size: 20px; /* å¢å¤§ä¸Šä¼ æ–‡æœ¬å­—ä½“ */
            font-weight: 500;
            margin-bottom: 10px;
        }

        .file-info {
            color: #666;
            font-size: 16px; /* å¢å¤§æ–‡ä»¶ä¿¡æ¯å­—ä½“ */
            line-height: 1.5;
        }

        .file-input {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px; /* å¢å¤§æˆåŠŸæ¶ˆæ¯å­—ä½“ */
            display: none;
            border-left: 4px solid #28a745;
        }

        /* éŸ³é¢‘å¤„ç†åŒºåŸŸä¼˜åŒ– */
        .processing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-group label {
            font-size: 18px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .option-group input, .option-group select {
            padding: 12px 14px; /* å¢å¤§è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .option-group input:focus, .option-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
            height: 50px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 18px; /* å¢å¤§è¿›åº¦æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 8px;
            text-align: center;
            font-weight: 500;
        }

        /* ASRä¼˜åŒ–é¢æ¿ä¼˜åŒ– */
        .asr-optimization-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #007bff;
            border-radius: 12px;
            border-left: 6px solid #007bff;
        }

        .optimization-header {
            font-size: 20px; /* å¢å¤§ä¼˜åŒ–æ ‡é¢˜å­—ä½“ */
            font-weight: 600;
            color: #007bff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .optimization-options {
            display: grid;
            gap: 15px;
        }

        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .option-row:last-child {
            border-bottom: none;
        }

        .option-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px; /* å¢å¤§é€‰é¡¹æ ‡ç­¾å­—ä½“ */
            color: #333;
            cursor: pointer;
            min-width: 200px;
            font-weight: 500;
        }

        .option-row input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .option-row select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-width: 150px;
        }

        .option-desc {
            font-size: 16px; /* å¢å¤§é€‰é¡¹æè¿°å­—ä½“ */
            color: #666;
            font-style: italic;
            flex: 1;
            text-align: right;
        }

        .help-text {
            font-size: 16px; /* å¢å¤§å¸®åŠ©æ–‡æœ¬å­—ä½“ */
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* éŸ³é¢‘æ‹¼æ¥åŒºåŸŸä¼˜åŒ– */
        .splice-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥ä¿¡æ¯å­—ä½“ */
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .splice-files-container {
            margin-bottom: 20px;
        }

        .splice-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .splice-files-header h4 {
            margin: 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥æ–‡ä»¶æ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .splice-files-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            min-height: 120px;
            padding: 15px;
            background-color: #fafafa;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-size: 18px; /* å¢å¤§ç©ºæ¶ˆæ¯å­—ä½“ */
            padding: 30px;
        }

        .splice-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 18px; /* å¢å¤§å†…è¾¹è· */
            margin-bottom: 8px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹å­—ä½“ */
            transition: all 0.3s ease;
        }

        .splice-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }

        .splice-item:last-child {
            margin-bottom: 0;
        }

        .splice-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .splice-item-name {
            font-weight: 600;
            color: #333;
            font-size: 18px; /* å¢å¤§æ‹¼æ¥é¡¹åç§°å­—ä½“ */
        }

        .file-type-label {
            font-size: 14px;
            color: #888;
            font-weight: normal;
            margin-left: 8px;
        }

        .splice-item-duration {
            color: #666;
            font-size: 16px; /* å¢å¤§æ‹¼æ¥é¡¹æ—¶é•¿å­—ä½“ */
        }

        .splice-item-controls {
            display: flex;
            gap: 8px;
        }

        .splice-item-controls button {
            padding: 8px 14px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§æŒ‰é’®å­—ä½“ */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .move-up {
            background-color: #28a745;
            color: white;
        }

        .move-down {
            background-color: #ffc107;
            color: black;
        }

        .remove-item {
            background-color: #dc3545;
            color: white;
        }

        .splice-preview {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .splice-preview h4 {
            margin: 0 0 15px 0;
            font-size: 20px; /* å¢å¤§æ‹¼æ¥é¢„è§ˆæ ‡é¢˜å­—ä½“ */
            color: #333;
            font-weight: 600;
        }

        /* ä¼šè®®çºªè¦ç”ŸæˆåŒºåŸŸä¼˜åŒ– */
        .minutes-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 18px; /* å¢å¤§è¡¨å•æ ‡ç­¾å­—ä½“ */
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            padding: 14px 16px; /* å¢å¤§è¡¨å•è¾“å…¥æ¡†å†…è¾¹è· */
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .result-area {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px; /* å‡å°‘å†…è¾¹è·ï¼Œè®©æ–‡æœ¬æ›´è´´è¿‘è¾¹æ¡† */
            min-height: 350px; /* å¢å¤§æœ€å°é«˜åº¦ä»¥åŒ¹é…å…¶ä»–å¡ç‰‡ */
            max-height: 450px; /* å¢å¤§æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
            font-size: 18px; /* å¢å¤§ç»“æœåŒºåŸŸå­—ä½“ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
            text-align: left; /* ç¡®ä¿æ–‡æœ¬å·¦å¯¹é½ */
        }

        /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 40px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #e0a800, #d39e00);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            min-height: 32px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }

        /* è¡¨å•æ§ä»¶ä¼˜åŒ– */
        .form-control {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        /* ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-text {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
            margin: 0;
        }

        /* è¿›åº¦æ¡ä¼˜åŒ– */
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 6px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¼˜åŒ– */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        .status-ready { 
            background-color: #28a745; 
        }
        
        .status-processing { 
            background-color: #ffc107; 
        }

        /* ä¼˜åŒ–ç»“æœæ˜¾ç¤º */
        .optimization-result {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 8px;
            font-size: 16px;
        }

        .optimization-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
        }

        .optimization-improvements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .improvement-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 4px 0;
        }

        .improvement-value {
            font-weight: bold;
            color: #28a745;
        }

        .improvement-value.negative {
            color: #dc3545;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            background-color: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .asr-trigger-label {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 6px;
        }

        .asr-trigger-label:hover {
            background-color: #f0f0f0;
        }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
        }
        </style>

        <script>
         // æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
         function openSpliceAsrModal() {
             const modal = document.getElementById('spliceAsrOptimizationModal');
             if (modal) {
                 modal.classList.add('show');
                 modal.style.display = 'flex';
             }
         }

         function closeSpliceAsrModal() {
             const modal = document.getElementById('spliceAsrOptimizationModal');
             modal.classList.remove('show');
             setTimeout(() => {
                 modal.style.display = 'none';
             }, 300);
         }

         function applySpliceAsrSettings() {
             // è·å–æ‰€æœ‰è®¾ç½®å€¼
             const settings = {
                 normalizeAudio: document.getElementById('spliceNormalizeAudio').checked,
                 removeSilence: document.getElementById('spliceRemoveSilence').checked,
                 enhanceVolume: document.getElementById('spliceEnhanceVolume').checked,
                 compressAudio: document.getElementById('spliceCompressAudio').checked,
                 targetSampleRate: document.getElementById('spliceTargetSampleRate').value
             };

             // æ›´æ–°ä¸»é¡µé¢çš„ASRä¼˜åŒ–checkboxçŠ¶æ€
             const enableSpliceASROptimization = document.getElementById('enableSpliceASROptimization');
             const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                      settings.enhanceVolume || settings.compressAudio;
             enableSpliceASROptimization.checked = hasAnyOptimization;

             // ä¿å­˜è®¾ç½®åˆ°å…¨å±€å˜é‡æˆ–localStorage
             window.spliceAsrSettings = settings;
             localStorage.setItem('spliceAsrSettings', JSON.stringify(settings));

             closeSpliceAsrModal();
             
             // æ˜¾ç¤ºåº”ç”¨æˆåŠŸæç¤º
             const helpText = document.querySelector('#spliceAsrOptimizationTrigger').parentElement.nextElementSibling;
             const originalText = helpText.textContent;
             helpText.textContent = 'âœ“ è®¾ç½®å·²åº”ç”¨';
             helpText.style.color = '#28a745';
             setTimeout(() => {
                 helpText.textContent = originalText;
                 helpText.style.color = '';
             }, 2000);
         }
         </script>
    </style>

    <!-- å“åº”å¼è®¾è®¡ -->
    <style>
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .workflow-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .step-content {
                flex-direction: column;
            }
            
            .step-controls {
                min-width: auto;
            }
            
            .processing-grid {
                grid-template-columns: 1fr;
            }
            
            .minutes-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .workflow-container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .container {
                height: auto;
                min-height: calc(100vh - 20px);
                margin: 10px;
            }
            
            .workflow-step {
                padding: 12px;
            }
            
            .step-header {
                padding: 8px 12px;
                margin: -12px -12px 12px -12px;
                font-size: 14px;
            }
            
            .step-number {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 12px;
                min-height: 36px;
            }
            
            .upload-area {
                padding: 15px;
                min-height: 80px;
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* éŸ³é¢‘æ‹¼æ¥å¡ç‰‡ç‰¹æ®Šæ ·å¼ - è°ƒæ•´å†…å®¹åŒºåŸŸé«˜åº¦ä»¥å¯¹é½æŒ‰é’® */
        .workflow-step:nth-child(2) .step-main {
            min-height: 450px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ä¼šè®®çºªè¦ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆä¼šè®®çºªè¦ã€‚æ”¯æŒéŸ³é¢‘è£å‰ªã€å‹ç¼©ç­‰é¢„å¤„ç†åŠŸèƒ½ã€‚</p>
        </div>

        <div class="workflow-container">
            <!-- æ­¥éª¤1: éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ä¸å¤„ç† -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <span>ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ä¸å¤„ç†</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                            <div class="upload-icon">â˜ï¸</div>
                            <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                            <div class="file-info">
                                æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                                æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                            </div>
                        </div>
                        <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac,.wma">
                        <div id="uploadSuccess" class="success-message">
                            âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼
                        </div>

                        <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>

                        <div class="processing-grid">
                            <div class="option-group">
                                <label>å¼€å§‹æ—¶é—´ (ç§’):</label>
                                <input type="number" id="startTime" placeholder="0" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>ç»“æŸæ—¶é—´ (ç§’):</label>
                                <input type="number" id="endTime" placeholder="è‡ªåŠ¨" min="0" step="1">
                            </div>
                            <div class="option-group">
                                <label>å‹ç¼©è´¨é‡:</label>
                                <select id="quality">
                                    <option value="high">é«˜è´¨é‡</option>
                                    <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                                    <option value="low">ä½è´¨é‡</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label id="asrOptimizationTrigger" class="asr-trigger-label">
                                    <input type="checkbox" id="enableASROptimization">
                                    å¯ç”¨ASRä¼˜åŒ–é¢„å¤„ç†
                                </label>
                                <div class="help-text">ç‚¹å‡»è®¾ç½®ASRä¼˜åŒ–å‚æ•°</div>
                            </div>
                        </div>

                        <div class="progress-container" id="processProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn" onclick="document.getElementById('audioFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                            <button class="btn btn-success" onclick="processAudio()" id="processBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¤„ç†éŸ³é¢‘
                            </button>
                            <button class="btn" onclick="previewAudio()" id="previewBtn" disabled>é¢„è§ˆ</button>
                            <button class="btn btn-warning" onclick="clearFile()">æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: éŸ³é¢‘æ‹¼æ¥ -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <span>ğŸ¬ éŸ³é¢‘æ‹¼æ¥</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="splice-info">
                            <p>é€‰æ‹©å¤šä¸ªå·²å¤„ç†çš„éŸ³é¢‘ç‰‡æ®µï¼ŒæŒ‰é¡ºåºæ‹¼æ¥æˆå®Œæ•´éŸ³é¢‘æ–‡ä»¶</p>
                        </div>
                        
                        <div class="splice-files-container">
                            <div class="splice-files-header">
                                <h4>éŸ³é¢‘ç‰‡æ®µåˆ—è¡¨</h4>
                                <div class="header-controls">
                                    <input type="file" id="localAudioFile" accept="audio/*" multiple style="display: none;" onchange="handleLocalAudioFiles(event)">
                                    <button class="btn btn-small" onclick="document.getElementById('localAudioFile').click()">é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button>
                                    <button class="btn btn-small" onclick="addAudioSegment()">æ·»åŠ å·²å¤„ç†ç‰‡æ®µ</button>
                                </div>
                            </div>
                            <div class="splice-files-list" id="spliceFilesList">
                                <div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–æ·»åŠ ç‰‡æ®µ</div>
                            </div>
                        </div>

                        <div class="splice-preview" id="splicePreview" style="display: none;">
                            <h4>æ‹¼æ¥é¢„è§ˆ</h4>
                            <audio id="spliceAudioPlayer" class="audio-player" controls>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        </div>

                        <div class="progress-container" id="spliceProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="spliceProgressFill"></div>
                            </div>
                            <div class="progress-text" id="spliceProgressText">æ‹¼æ¥ä¸­...</div>
                        </div>
                        
                        <!-- ASRä¼˜åŒ–é€‰é¡¹ -->
                        <div class="option-group" style="margin-top: 15px;">
                            <div class="asr-trigger-container">
                                <label id="spliceAsrOptimizationTrigger" class="asr-trigger-label">
                                    <input type="checkbox" id="enableSpliceASROptimization">
                                    å¯ç”¨ASRä¼˜åŒ–é¢„å¤„ç†ï¼ˆæ‹¼æ¥åï¼‰
                                </label>
                            </div>
                            <div class="help-text">ç‚¹å‡»è®¾ç½®ASRä¼˜åŒ–å‚æ•°</div>
                        </div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="spliceAudio()" id="spliceBtn" disabled>
                                <span class="status-indicator status-ready"></span>å¼€å§‹æ‹¼æ¥
                            </button>
                            <button class="btn" onclick="previewSplice()" id="previewSpliceBtn" disabled>é¢„è§ˆ</button>
                            <button class="btn btn-primary" onclick="downloadSplicedAudio()" id="downloadSpliceBtn" disabled>ä¸‹è½½</button>
                            <button class="btn btn-warning" onclick="clearSpliceList()">æ¸…ç©ºåˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º -->
            <div class="workflow-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <span>ğŸ“ ä¼šè®®çºªè¦ç”Ÿæˆå’Œæ˜¾ç¤º</span>
                </div>
                <div class="step-content">
                    <div class="step-main">
                        <div class="minutes-form">
                            <div class="form-group">
                                <label>å‚ä¸äººæ•°:</label>
                                <input type="number" id="participantCount" placeholder="è¯·è¾“å…¥å‚ä¸äººæ•°" min="1" max="50" value="5">
                            </div>
                            <div class="form-group">
                                <label>ä¼šè®®ä¸»é¢˜:</label>
                                <input type="text" id="meetingTopic" placeholder="è¯·è¾“å…¥ä¼šè®®ä¸»é¢˜">
                            </div>
                        </div>

                        <div class="result-area" id="minutesResult">æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...</div>
                    </div>
                    <div class="step-controls">
                        <div class="button-group">
                            <button class="btn btn-success" onclick="generateMinutes()" id="generateBtn" disabled>
                                <span class="status-indicator status-ready"></span>ç”Ÿæˆä¼šè®®çºªè¦
                            </button>
                            <button class="btn" onclick="downloadMinutes()" id="downloadBtn" disabled>ä¸‹è½½çºªè¦</button>
                            <button class="btn btn-warning" onclick="clearMinutes()">æ¸…ç©ºç»“æœ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let processedAudioUrl = null;
        let isProcessing = false;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('audioFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            console.log('ä¼šè®®çºªè¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        async function uploadFile(file) {
            console.log('uploadFile å‡½æ•°è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file);
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/aac', 'audio/ogg', 'audio/flac', 'audio/x-ms-wma'];
            if (!allowedTypes.includes(file.type)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ã€‚');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°è¶…è¿‡100MBé™åˆ¶ï¼');
                return;
            }

            // å­˜å‚¨æ–‡ä»¶
            uploadedFile = file;
            processedAudioUrl = URL.createObjectURL(file);

            // æ›´æ–°UIæ˜¾ç¤º - æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadArea = document.getElementById('uploadArea');
            const uploadSuccess = document.getElementById('uploadSuccess');
            const resultArea = document.getElementById('minutesResult');
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            uploadArea.innerHTML = `
                <div class="upload-icon">â³</div>
                <div class="upload-text">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>
                <div class="file-info">
                    <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                    <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>ç±»å‹:</strong> ${file.type}
                </div>
            `;
            
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('audio_file', file);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                // ä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°UI
                uploadArea.innerHTML = `
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</div>
                    <div class="file-info">
                        <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                        <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <strong>ç±»å‹:</strong> ${file.type}
                    </div>
                `;
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                uploadSuccess.style.display = 'block';
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ç°åœ¨å¯ä»¥ç›´æ¥ç”Ÿæˆä¼šè®®çºªè¦ã€‚';
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶ID
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id;
                
                // å¯ç”¨ç”Ÿæˆä¼šè®®çºªè¦æŒ‰é’®å’ŒéŸ³é¢‘å¤„ç†æŒ‰é’®
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('processBtn').disabled = false;
                
                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                if (audioPlayer) {
                    audioPlayer.src = processedAudioUrl;
                    audioPlayer.style.display = 'block';
                }

                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                
                // ä¸Šä¼ å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                uploadArea.innerHTML = `
                    <div class="upload-icon">âŒ</div>
                    <div class="upload-text">æ–‡ä»¶ä¸Šä¼ å¤±è´¥</div>
                    <div class="file-info">
                        <strong>é”™è¯¯:</strong> ${error.message}
                    </div>
                `;
                
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
                
                // ä¿æŒæŒ‰é’®ç¦ç”¨çŠ¶æ€
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('processBtn').disabled = true;
            }
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå®é™…ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
        async function processUploadedFile() {
            if (!uploadedFile) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            const resultArea = document.getElementById('minutesResult');
            const originalText = resultArea.textContent;
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨ASRä¼˜åŒ–
                const enableOptimization = document.getElementById('enableASROptimization').checked;
                
                if (enableOptimization) {
                    resultArea.textContent = 'æ­£åœ¨è¿›è¡ŒASRä¼˜åŒ–é¢„å¤„ç†...';
                    await optimizeAudioForASR();
                    resultArea.textContent = 'ASRä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';
                }

                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å¯ä»¥å¼€å§‹ç”Ÿæˆä¼šè®®çºªè¦æˆ–å¤„ç†éŸ³é¢‘ã€‚';
                document.getElementById('processBtn').disabled = false; // å¯ç”¨éŸ³é¢‘å¤„ç†æŒ‰é’®
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶IDï¼Œä¾›åç»­ä½¿ç”¨
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id; // ç›´æ¥ä½¿ç”¨dify_file_idä½œä¸ºåŸå§‹æ–‡ä»¶ID
                
                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
            }
        }

        // ASRä¼˜åŒ–é¢„å¤„ç†å‡½æ•°
        async function optimizeAudioForASR() {
            if (!uploadedFile) {
                throw new Error('æ²¡æœ‰å¯ä¼˜åŒ–çš„éŸ³é¢‘æ–‡ä»¶');
            }

            try {
                // è·å–ä¼˜åŒ–å‚æ•°
                const targetSampleRate = parseInt(document.getElementById('targetSampleRate').value);
                const enableNormalization = document.getElementById('normalizeAudio').checked;
                const enableSilenceRemoval = document.getElementById('removeSilence').checked;
                const enableVolumeEnhancement = document.getElementById('enhanceVolume').checked;
                const enableDynamicCompression = document.getElementById('compressAudio').checked;

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                formData.append('target_sample_rate', targetSampleRate);
                formData.append('enable_normalization', enableNormalization);
                formData.append('enable_silence_removal', enableSilenceRemoval);
                formData.append('enable_volume_enhancement', enableVolumeEnhancement);
                formData.append('enable_dynamic_compression', enableDynamicCompression);

                const response = await fetch('/meeting_minutes/optimize_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘ä¼˜åŒ–å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘ä¼˜åŒ–å¤±è´¥');
                }

                // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
                displayOptimizationResult(result);

                // åˆ›å»ºä¼˜åŒ–åçš„æ–‡ä»¶å¯¹è±¡
                const optimizedBlob = await fetch(result.optimized_file_url).then(r => r.blob());
                const optimizedFile = new File([optimizedBlob], result.optimized_filename, { type: 'audio/mpeg' });
                
                // æ›¿æ¢åŸå§‹æ–‡ä»¶
                uploadedFile = optimizedFile;
                
                console.log('éŸ³é¢‘ä¼˜åŒ–å®Œæˆ:', result);
                
            } catch (error) {
                console.error('éŸ³é¢‘ä¼˜åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        function displayOptimizationResult(result) {
            const resultDiv = document.getElementById('optimizationResult');
            if (!resultDiv) return;

            const improvements = result.improvements || {};
            
            let html = `
                <div class="optimization-result">
                    <strong>âœ… ASRä¼˜åŒ–å®Œæˆ</strong>
                    <div class="optimization-improvements">
                        <div class="improvement-item">
                            <span>é‡‡æ ·ç‡:</span>
                            <span class="improvement-value">${improvements.sample_rate_before || 'N/A'} â†’ ${improvements.sample_rate_after || 'N/A'} Hz</span>
                        </div>
                        <div class="improvement-item">
                            <span>å£°é“:</span>
                            <span class="improvement-value">${improvements.channels_before || 'N/A'} â†’ ${improvements.channels_after || 1}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ—¶é•¿å˜åŒ–:</span>
                            <span class="improvement-value">${improvements.duration_change || 'N/A'}</span>
                        </div>
                        <div class="improvement-item">
                            <span>æ–‡ä»¶å¤§å°:</span>
                            <span class="improvement-value">${formatFileSize(result.original_info?.file_size || 0)} â†’ ${formatFileSize(result.optimized_info?.file_size || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆ‡æ¢ä¼˜åŒ–é€‰é¡¹æ˜¾ç¤º/éšè—
        function toggleOptimizationOptions() {
            const checkbox = document.getElementById('enableASROptimization');
            const panel = document.getElementById('optimizationOptionsPanel');
            const result = document.getElementById('optimizationResult');
            
            if (checkbox.checked) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
                if (result) result.style.display = 'none';
            }
        }

        function clearFile() {
            uploadedFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
        }

        // éŸ³é¢‘å¤„ç†ç›¸å…³
        async function processAudio() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
            if (!uploadedFile.dify_file_id) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            isProcessing = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

            try {
                // è·å–å¤„ç†å‚æ•°
                const startTime = parseFloat(document.getElementById('startTime').value) || 0;
                const endTime = parseFloat(document.getElementById('endTime').value) || null;
                const quality = document.getElementById('quality').value;
                const compress = quality !== 'high'; // é«˜è´¨é‡ä¸å‹ç¼©ï¼Œä¸­ç­‰å’Œä½è´¨é‡å‹ç¼©

                // è°ƒç”¨åç«¯éŸ³é¢‘å¤„ç†API
                const response = await fetch('/meeting_minutes/process_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: uploadedFile.original_file_id || uploadedFile.name.split('.')[0],
                        start_time: startTime,
                        end_time: endTime,
                        compress: compress
                    })
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                // å¤„ç†æˆåŠŸï¼Œä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶åˆ°Dify
                document.getElementById('progressText').textContent = 'æ­£åœ¨ä¸Šä¼ å¤„ç†åçš„éŸ³é¢‘...';
                
                const uploadResponse = await fetch('/meeting_minutes/upload_processed_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processed_file_id: result.processed_file_id
                    })
                });

                if (!uploadResponse.ok) {
                    throw new Error('å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                // ä¿å­˜å¤„ç†åçš„æ–‡ä»¶ä¿¡æ¯
                uploadedFile.processed_file_id = result.processed_file_id; // ä½¿ç”¨æœ¬åœ°å¤„ç†ç»“æœçš„ID
                uploadedFile.processed_filename = result.processed_filename;
                uploadedFile.processed_file_url = result.processed_file_url; // ä¿å­˜å¤„ç†åéŸ³é¢‘æ–‡ä»¶çš„URL
                uploadedFile.duration = result.duration; // ä¿å­˜éŸ³é¢‘æ—¶é•¿
                uploadedFile.dify_processed_file_id = uploadResult.dify_file_id; // ä¿å­˜Difyä¸Šä¼ åçš„ID
                
                finishProcessing();
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                document.getElementById('progressText').textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
                stopProcessing();
                alert('éŸ³é¢‘å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        function finishProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('progressText').textContent = 'å¤„ç†å®Œæˆï¼';
            
            setTimeout(() => {
                document.getElementById('processProgress').style.display = 'none';
            }, 2000);
            
            // å¦‚æœæœ‰å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶URLï¼Œæ›´æ–°éŸ³é¢‘æ’­æ”¾å™¨çš„src
            if (uploadedFile && uploadedFile.processed_file_url) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = uploadedFile.processed_file_url;
                processedAudioUrl = uploadedFile.processed_file_url;
                console.log('éŸ³é¢‘æ’­æ”¾å™¨å·²æ›´æ–°ä¸ºå¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶:', uploadedFile.processed_file_url);
            } else {
                processedAudioUrl = document.getElementById('audioPlayer').src;
            }
            
            console.log('éŸ³é¢‘å¤„ç†å®Œæˆ');
        }

        function previewAudio() {
            if (processedAudioUrl) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.currentTime = document.getElementById('startTime').value || 0;
                audioPlayer.play();
            }
        }

        function stopProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('processProgress').style.display = 'none';
        }

        // ä¼šè®®çºªè¦ç”Ÿæˆç›¸å…³
        async function generateMinutes() {
            if (!uploadedFile && !splicedAudioUrl) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹¼æ¥éŸ³é¢‘ï¼');
                return;
            }

            const participantCount = document.getElementById('participantCount').value;
            const meetingTopic = document.getElementById('meetingTopic').value;
            
            if (!participantCount) {
                alert('è¯·è¾“å…¥å‚ä¸äººæ•°ï¼');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');

            try {
                let fileId;
                
                // æ–‡ä»¶ä¼˜å…ˆçº§ï¼šæ‹¼æ¥æ–‡ä»¶ > å¤„ç†åæ–‡ä»¶ > åŸå§‹æ–‡ä»¶
                if (splicedAudioUrl && splicedAudioFilename) {
                    // 1. ä¼˜å…ˆä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶
                    resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ‹¼æ¥åçš„éŸ³é¢‘æ–‡ä»¶...';
                    console.log('ä½¿ç”¨æ‹¼æ¥åçš„æ–‡ä»¶:', splicedAudioFilename);
                    
                    // éœ€è¦å…ˆå°†æ‹¼æ¥æ–‡ä»¶ä¸Šä¼ åˆ°Difyè·å–file_id
                    try {
                        const response = await fetch(splicedAudioUrl);
                        const blob = await response.blob();
                        const file = new File([blob], splicedAudioFilename, { type: 'audio/mpeg' });
                        
                        const formData = new FormData();
                        formData.append('audio_file', file);
                        
                        const uploadResp = await fetch('/meeting_minutes/upload_audio', {
                            method: 'POST',
                            body: formData
                        });

                        if (!uploadResp.ok) {
                            throw new Error('æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                        }

                        const uploadData = await uploadResp.json();
                        if (!uploadData.success || !uploadData.dify_file_id) {
                            throw new Error('æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (uploadData.error || 'æœªçŸ¥é”™è¯¯'));
                        }
                        
                        fileId = uploadData.dify_file_id;
                        resultArea.textContent = 'æ‹¼æ¥éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦...';
                    } catch (error) {
                        console.error('æ‹¼æ¥æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–æ–‡ä»¶:', error);
                        // å¦‚æœæ‹¼æ¥æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œé™çº§åˆ°å¤„ç†åçš„æ–‡ä»¶
                         if (uploadedFile && uploadedFile.dify_processed_file_id) {
                             fileId = uploadedFile.dify_processed_file_id;
                             resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                             console.log('é™çº§ä½¿ç”¨å¤„ç†åæ–‡ä»¶çš„Dify ID:', fileId);
                        } else if (uploadedFile && uploadedFile.dify_file_id) {
                            fileId = uploadedFile.dify_file_id;
                            resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                            console.log('é™çº§ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                        } else {
                            throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘æ–‡ä»¶');
                        }
                    }
                } else if (uploadedFile && uploadedFile.dify_processed_file_id) {
                    // 2. ä½¿ç”¨å¤„ç†åæ–‡ä»¶ä¸Šä¼ åˆ°Difyçš„ID
                    fileId = uploadedFile.dify_processed_file_id;
                    resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨å¤„ç†åæ–‡ä»¶çš„Dify ID:', fileId);
                } else if (uploadedFile && uploadedFile.dify_file_id) {
                    // 3. ä½¿ç”¨åŸå§‹æ–‡ä»¶ID
                    fileId = uploadedFile.dify_file_id;
                    resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                } else {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘æ–‡ä»¶');
                }

                // 2. è°ƒç”¨ç”Ÿæˆä¼šè®®çºªè¦çš„API
                const generateResp = await fetch('/meeting_minutes/generate_minutes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: fileId,
                        participants_count: parseInt(participantCount),
                        additional_info: meetingTopic || ''
                    })
                });

                if (!generateResp.ok) {
                    throw new Error('ä¼šè®®çºªè¦ç”Ÿæˆæ¥å£è°ƒç”¨å¤±è´¥');
                }

                // 3. å¤„ç†æµå¼å“åº”
                const reader = generateResp.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let result = '';

                resultArea.textContent = 'æ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦ï¼Œè¯·ç¨å€™...';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split(/\n\n/);
                    buffer = lines.pop();

                    for (let line of lines) {
                        if (line.startsWith('data:')) {
                            let content = line.slice(5).trim();
                            if (content.startsWith('[ERROR]')) {
                                throw new Error(content);
                            } else {
                                try {
                                    let obj = JSON.parse(content);
                                    
                                    // å¤„ç†Difyå·¥ä½œæµçš„å“åº”
                                    if (obj.event === 'message' && obj.answer) {
                                        result += obj.answer;
                                        resultArea.textContent = result;
                                    } else if (obj.event === 'message_end') {
                                        // ç”Ÿæˆå®Œæˆ
                                        document.getElementById('downloadBtn').disabled = false;
                                        console.log('ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆ');
                                        break;
                                    } else if (obj.event === 'error') {
                                        throw new Error(obj.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æå¤±è´¥çš„ç‰‡æ®µï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„JSON
                                    console.warn('JSONè§£æå¤±è´¥:', content);
                                }
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰è·å¾—ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                if (!result.trim()) {
                    resultArea.textContent = 'ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆï¼Œä½†æœªè·å¾—æœ‰æ•ˆå†…å®¹ã€‚è¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶è´¨é‡æˆ–é‡è¯•ã€‚';
                }

            } catch (error) {
                console.error('ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥:', error);
                resultArea.textContent = 'ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥: ' + error.message;
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function downloadMinutes() {
            const content = document.getElementById('minutesResult').textContent;
            if (!content || content.includes('ç­‰å¾…éŸ³é¢‘å¤„ç†')) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¼šè®®çºªè¦ï¼');
                return;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¼šè®®çºªè¦_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearMinutes() {
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
        }

        function clearFile() {
            // é‡ç½®æ–‡ä»¶ç›¸å…³å˜é‡
            uploadedFile = null;
            processedAudioUrl = null;
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">â˜ï¸</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="file-info">
                    æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                    æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                </div>
            `;
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('audioFile').value = '';
            
            // éšè—æˆåŠŸæ¶ˆæ¯
            document.getElementById('uploadSuccess').style.display = 'none';
            
            // ç¦ç”¨ç›¸å…³æŒ‰é’®
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            
            // éšè—éŸ³é¢‘æ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            
            // é‡ç½®ä¼šè®®çºªè¦ç»“æœ
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
            
            console.log('æ–‡ä»¶å·²æ¸…é™¤');
        }

        // éŸ³é¢‘æ‹¼æ¥ç›¸å…³å˜é‡å’Œå‡½æ•°
        let spliceSegments = [];
        let splicedAudioUrl = null;
        let splicedAudioFilename = null;

        // å¤„ç†æœ¬åœ°éŸ³é¢‘æ–‡ä»¶é€‰æ‹©
        function handleLocalAudioFiles(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('audio/')) {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ï¼`);
                    continue;
                }

                // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBï¼‰
                const maxSize = 50 * 1024 * 1024; // 50MB
                if (file.size > maxSize) {
                    alert(`æ–‡ä»¶ "${file.name}" è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„éŸ³é¢‘æ–‡ä»¶ï¼`);
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªæ–‡ä»¶
                const existingSegment = spliceSegments.find(seg => seg.filename === file.name && seg.type === 'local');
                if (existingSegment) {
                    alert(`æ–‡ä»¶ "${file.name}" å·²åœ¨æ‹¼æ¥åˆ—è¡¨ä¸­ï¼`);
                    continue;
                }

                // åˆ›å»ºæœ¬åœ°æ–‡ä»¶å¯¹è±¡URL
                const fileUrl = URL.createObjectURL(file);
                
                // è·å–éŸ³é¢‘æ—¶é•¿
                const audio = new Audio();
                audio.src = fileUrl;
                audio.addEventListener('loadedmetadata', function() {
                    const duration = audio.duration;
                    
                    // æ·»åŠ åˆ°æ‹¼æ¥åˆ—è¡¨
                    const segment = {
                        file_id: `local_${Date.now()}_${i}`, // ç”Ÿæˆå”¯ä¸€ID
                        filename: file.name,
                        duration: duration,
                        file_url: fileUrl,
                        file_object: file, // ä¿å­˜åŸå§‹æ–‡ä»¶å¯¹è±¡
                        type: 'local' // æ ‡è®°ä¸ºæœ¬åœ°æ–‡ä»¶
                    };

                    spliceSegments.push(segment);
                    updateSpliceList();
                    updateSpliceButtons();
                });
                
                audio.addEventListener('error', function() {
                    alert(`æ— æ³•åŠ è½½éŸ³é¢‘æ–‡ä»¶ "${file.name}"ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåï¼`);
                    URL.revokeObjectURL(fileUrl); // æ¸…ç†URLå¯¹è±¡
                });
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
            event.target.value = '';
        }

        // æ·»åŠ éŸ³é¢‘ç‰‡æ®µåˆ°æ‹¼æ¥åˆ—è¡¨
        function addAudioSegment() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // ç¡®å®šä½¿ç”¨çš„æ–‡ä»¶IDå’Œç›¸å…³ä¿¡æ¯
            let fileId, filename, fileUrl;
            
            if (uploadedFile.processed_file_id) {
                // ä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶
                fileId = uploadedFile.processed_file_id;
                filename = uploadedFile.processed_filename || `${uploadedFile.processed_file_id}.mp3`;
                // æ„å»ºå®Œæ•´çš„URLç”¨äºé¢„è§ˆ
                fileUrl = window.location.origin + uploadedFile.processed_file_url;
            } else if (uploadedFile.dify_file_id) {
                // ä½¿ç”¨åŸå§‹æ–‡ä»¶
                fileId = uploadedFile.dify_file_id;
                filename = uploadedFile.name;
                fileUrl = URL.createObjectURL(uploadedFile);
            } else {
                alert('è¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªç‰‡æ®µ
            const existingSegment = spliceSegments.find(seg => seg.file_id === fileId);
            if (existingSegment) {
                alert('è¯¥éŸ³é¢‘ç‰‡æ®µå·²åœ¨æ‹¼æ¥åˆ—è¡¨ä¸­ï¼');
                return;
            }

            // æ·»åŠ åˆ°æ‹¼æ¥åˆ—è¡¨
            const segment = {
                file_id: fileId,
                filename: filename,
                duration: uploadedFile.duration || 0,
                url: fileUrl
            };

            spliceSegments.push(segment);
            updateSpliceList();
            updateSpliceButtons();
            
            console.log('æ·»åŠ éŸ³é¢‘ç‰‡æ®µ:', segment);
        }

        // æ›´æ–°æ‹¼æ¥åˆ—è¡¨æ˜¾ç¤º
        function updateSpliceList() {
            const listContainer = document.getElementById('spliceFilesList');
            
            if (spliceSegments.length === 0) {
                listContainer.innerHTML = '<div class="empty-message">æš‚æ— éŸ³é¢‘ç‰‡æ®µï¼Œè¯·å…ˆå¤„ç†éŸ³é¢‘æ–‡ä»¶æˆ–é€‰æ‹©æœ¬åœ°æ–‡ä»¶</div>';
                return;
            }

            let html = '';
            spliceSegments.forEach((segment, index) => {
                // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡è¯†
                const typeIcon = segment.type === 'local' ? 'ğŸ“' : 'ğŸµ';
                const typeLabel = segment.type === 'local' ? 'æœ¬åœ°æ–‡ä»¶' : 'å·²å¤„ç†';
                
                html += `
                    <div class="splice-item" data-index="${index}">
                        <div class="splice-item-info">
                            <div class="splice-item-name">
                                ${typeIcon} ${segment.filename}
                                <span class="file-type-label">(${typeLabel})</span>
                            </div>
                            <div class="splice-item-duration">æ—¶é•¿: ${formatDuration(segment.duration)}</div>
                        </div>
                        <div class="splice-item-controls">
                            <button class="move-up" onclick="moveSpliceItem(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                            <button class="move-down" onclick="moveSpliceItem(${index}, 1)" ${index === spliceSegments.length - 1 ? 'disabled' : ''}>â†“</button>
                            <button class="remove-item" onclick="removeSpliceItem(${index})">Ã—</button>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // ç§»åŠ¨æ‹¼æ¥é¡¹ç›®
         function moveSpliceItem(index, direction) {
             const newIndex = index + direction;
             if (newIndex < 0 || newIndex >= spliceSegments.length) return;

             // äº¤æ¢ä½ç½®
             [spliceSegments[index], spliceSegments[newIndex]] = [spliceSegments[newIndex], spliceSegments[index]];
             updateSpliceList();
         }

         // åˆ é™¤æ‹¼æ¥é¡¹ç›®
        function removeSpliceItem(index) {
            const segment = spliceSegments[index];
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œéœ€è¦æ¸…ç†URLå¯¹è±¡
            if (segment && segment.type === 'local' && segment.file_url) {
                URL.revokeObjectURL(segment.file_url);
            }
            
            spliceSegments.splice(index, 1);
            updateSpliceList();
            updateSpliceButtons();
        }

         // æ›´æ–°æ‹¼æ¥ç›¸å…³æŒ‰é’®çŠ¶æ€
         function updateSpliceButtons() {
             const hasSegments = spliceSegments.length > 0;
             document.getElementById('spliceBtn').disabled = !hasSegments;
             document.getElementById('previewSpliceBtn').disabled = !hasSegments;
         }

         // å¼€å§‹æ‹¼æ¥éŸ³é¢‘
        async function spliceAudio() {
            if (spliceSegments.length === 0) {
                alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                return;
            }

            document.getElementById('spliceBtn').disabled = true;
            document.getElementById('spliceProgress').style.display = 'block';
            document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨å‡†å¤‡æ‹¼æ¥...';

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ–‡ä»¶éœ€è¦å…ˆä¸Šä¼ 
                const localFiles = spliceSegments.filter(seg => seg.type === 'local');
                const processedSegments = [...spliceSegments];

                if (localFiles.length > 0) {
                    document.getElementById('spliceProgressText').textContent = `æ­£åœ¨ä¸Šä¼ æœ¬åœ°æ–‡ä»¶ (0/${localFiles.length})...`;
                    
                    // é€ä¸ªä¸Šä¼ æœ¬åœ°æ–‡ä»¶
                    for (let i = 0; i < localFiles.length; i++) {
                        const localFile = localFiles[i];
                        document.getElementById('spliceProgressText').textContent = `æ­£åœ¨ä¸Šä¼ æœ¬åœ°æ–‡ä»¶ (${i + 1}/${localFiles.length})...`;
                        
                        // åˆ›å»ºFormDataä¸Šä¼ æ–‡ä»¶
                        const formData = new FormData();
                        formData.append('audio_file', localFile.file_object);
                        
                        const uploadResponse = await fetch('/meeting_minutes/upload_audio', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error(`ä¸Šä¼ æ–‡ä»¶ "${localFile.filename}" å¤±è´¥`);
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        if (!uploadResult.success) {
                            throw new Error(`ä¸Šä¼ æ–‡ä»¶ "${localFile.filename}" å¤±è´¥: ${uploadResult.error || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                        
                        // æ›´æ–°segmentä¿¡æ¯ï¼Œä½¿ç”¨ä¸Šä¼ åçš„file_id
                        const segmentIndex = processedSegments.findIndex(seg => seg.file_id === localFile.file_id);
                        if (segmentIndex !== -1) {
                            processedSegments[segmentIndex].file_id = uploadResult.dify_file_id;
                            processedSegments[segmentIndex].type = 'uploaded'; // æ ‡è®°ä¸ºå·²ä¸Šä¼ 
                        }
                    }
                }

                document.getElementById('spliceProgressText').textContent = 'æ­£åœ¨æ‹¼æ¥éŸ³é¢‘...';

                // æ‰§è¡Œæ‹¼æ¥
                const enableASROptimization = document.getElementById('enableSpliceASROptimization').checked;
                
                // è·å–è¯¦ç»†çš„ASRä¼˜åŒ–å‚æ•°
                let asrOptimizationParams = {};
                if (enableASROptimization && window.spliceAsrSettings) {
                    asrOptimizationParams = {
                        normalize_audio: window.spliceAsrSettings.normalizeAudio,
                        remove_silence: window.spliceAsrSettings.removeSilence,
                        enhance_volume: window.spliceAsrSettings.enhanceVolume,
                        compress_audio: window.spliceAsrSettings.compressAudio,
                        target_sample_rate: parseInt(window.spliceAsrSettings.targetSampleRate)
                    };
                }
                
                const response = await fetch('/meeting_minutes/splice_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segments: processedSegments.map(seg => ({
                            file_id: seg.file_id,
                            filename: seg.filename
                        })),
                        enable_asr_optimization: enableASROptimization,
                        asr_optimization_params: asrOptimizationParams
                    })
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘æ‹¼æ¥å¤±è´¥');
                }

                const result = await response.json();
                if (result.success) {
                    // æ„å»ºå®Œæ•´çš„URL
                    const fullUrl = window.location.origin + result.spliced_file_url;
                    splicedAudioUrl = fullUrl;
                    splicedAudioFilename = result.spliced_filename;
                    document.getElementById('spliceProgressText').textContent = 'æ‹¼æ¥å®Œæˆï¼';
                    document.getElementById('downloadSpliceBtn').disabled = false;
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    const previewContainer = document.getElementById('splicePreview');
                     const audioPlayer = document.getElementById('spliceAudioPlayer');
                     audioPlayer.src = fullUrl;
                     previewContainer.style.display = 'block';
                     
                     setTimeout(() => {
                         document.getElementById('spliceProgress').style.display = 'none';
                     }, 2000);
                 } else {
                     throw new Error(result.error || 'æ‹¼æ¥å¤±è´¥');
                 }

             } catch (error) {
                 console.error('éŸ³é¢‘æ‹¼æ¥å¤±è´¥:', error);
                 document.getElementById('spliceProgressText').textContent = 'æ‹¼æ¥å¤±è´¥: ' + error.message;
                 setTimeout(() => {
                     document.getElementById('spliceProgress').style.display = 'none';
                 }, 3000);
             } finally {
                 document.getElementById('spliceBtn').disabled = false;
             }
         }

         // é¢„è§ˆæ‹¼æ¥æ•ˆæœ
         async function previewSplice() {
             if (spliceSegments.length === 0) {
                 alert('è¯·å…ˆæ·»åŠ éŸ³é¢‘ç‰‡æ®µï¼');
                 return;
             }

             // å¦‚æœå·²ç»æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œç›´æ¥é¢„è§ˆ
             if (splicedAudioUrl) {
                 const previewContainer = document.getElementById('splicePreview');
                 const audioPlayer = document.getElementById('spliceAudioPlayer');
                 audioPlayer.src = splicedAudioUrl;
                 previewContainer.style.display = 'block';
                 audioPlayer.play();
                 return;
             }

             // å¦‚æœæ²¡æœ‰æ‹¼æ¥åçš„éŸ³é¢‘ï¼Œå…ˆæ‰§è¡Œæ‹¼æ¥
             try {
                 document.getElementById('previewSpliceBtn').disabled = true;
                 document.getElementById('previewSpliceBtn').textContent = 'æ­£åœ¨æ‹¼æ¥...';
                 
                 await spliceAudio();
                 
                 // æ‹¼æ¥å®Œæˆåé¢„è§ˆ
                 if (splicedAudioUrl) {
                     const previewContainer = document.getElementById('splicePreview');
                     const audioPlayer = document.getElementById('spliceAudioPlayer');
                     audioPlayer.src = splicedAudioUrl;
                     previewContainer.style.display = 'block';
                     audioPlayer.play();
                 }
             } catch (error) {
                 console.error('é¢„è§ˆæ‹¼æ¥å¤±è´¥:', error);
                 alert('é¢„è§ˆæ‹¼æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
             } finally {
                 document.getElementById('previewSpliceBtn').disabled = false;
                 document.getElementById('previewSpliceBtn').textContent = 'é¢„è§ˆæ‹¼æ¥';
             }
         }

         // ä¸‹è½½æ‹¼æ¥åçš„éŸ³é¢‘
         function downloadSplicedAudio() {
             if (!splicedAudioUrl) {
                 alert('è¯·å…ˆæ‹¼æ¥éŸ³é¢‘ï¼');
                 return;
             }

             const a = document.createElement('a');
             a.href = splicedAudioUrl;
             a.download = splicedAudioFilename || `æ‹¼æ¥éŸ³é¢‘_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.mp3`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
         }

         // æ¸…ç©ºæ‹¼æ¥åˆ—è¡¨
        function clearSpliceList() {
            // æ¸…ç†æ‰€æœ‰æœ¬åœ°æ–‡ä»¶çš„URLå¯¹è±¡
            spliceSegments.forEach(segment => {
                if (segment.type === 'local' && segment.file_url) {
                    URL.revokeObjectURL(segment.file_url);
                }
            });
            
            spliceSegments = [];
            splicedAudioUrl = null;
            splicedAudioFilename = null;
            updateSpliceList();
            updateSpliceButtons();
            document.getElementById('splicePreview').style.display = 'none';
            document.getElementById('downloadSpliceBtn').disabled = true;
        }

         // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
         function formatDuration(seconds) {
             if (!seconds || seconds === 0) return 'æœªçŸ¥';
             const minutes = Math.floor(seconds / 60);
             const remainingSeconds = Math.floor(seconds % 60);
             return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
         }

         // ASRä¼˜åŒ–æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
         function openAsrModal() {
             const modal = document.getElementById('asrOptimizationModal');
             modal.classList.add('show');
             modal.style.display = 'flex';
         }

         function closeAsrModal() {
             const modal = document.getElementById('asrOptimizationModal');
             modal.classList.remove('show');
             setTimeout(() => {
                 modal.style.display = 'none';
             }, 300);
         }

         function applyAsrSettings() {
             // è·å–æ‰€æœ‰è®¾ç½®å€¼
             const settings = {
                 normalizeAudio: document.getElementById('normalizeAudio').checked,
                 removeSilence: document.getElementById('removeSilence').checked,
                 enhanceVolume: document.getElementById('enhanceVolume').checked,
                 compressAudio: document.getElementById('compressAudio').checked,
                 targetSampleRate: document.getElementById('targetSampleRate').value
             };

             // æ›´æ–°ä¸»é¡µé¢çš„ASRä¼˜åŒ–checkboxçŠ¶æ€
             const enableASROptimization = document.getElementById('enableASROptimization');
             const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                      settings.enhanceVolume || settings.compressAudio;
             enableASROptimization.checked = hasAnyOptimization;

             // ä¿å­˜è®¾ç½®åˆ°å…¨å±€å˜é‡æˆ–localStorage
             window.asrSettings = settings;
             localStorage.setItem('asrSettings', JSON.stringify(settings));

             closeAsrModal();
             
             // æ˜¾ç¤ºåº”ç”¨æˆåŠŸæç¤º
             const helpText = document.querySelector('#asrOptimizationTrigger + .help-text');
             const originalText = helpText.textContent;
             helpText.textContent = 'âœ“ è®¾ç½®å·²åº”ç”¨';
             helpText.style.color = '#28a745';
             setTimeout(() => {
                 helpText.textContent = originalText;
                 helpText.style.color = '';
             }, 2000);
         }

         // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
         document.addEventListener('DOMContentLoaded', function() {
             // ä¸ºASRä¼˜åŒ–è§¦å‘å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
             document.getElementById('asrOptimizationTrigger').addEventListener('click', function(e) {
                 e.preventDefault();
                 openAsrModal();
             });

             // ä¸ºæ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è§¦å‘å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
             const spliceAsrTrigger = document.getElementById('spliceAsrOptimizationTrigger');
             if (spliceAsrTrigger) {
                 spliceAsrTrigger.addEventListener('click', function(e) {
                     e.preventDefault();
                     e.stopPropagation();
                     openSpliceAsrModal();
                 });
             }

             // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
             document.getElementById('asrOptimizationModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     closeAsrModal();
                 }
             });

             // ç‚¹å‡»æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
             document.getElementById('spliceAsrOptimizationModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     closeSpliceAsrModal();
                 }
             });

             // åŠ è½½ä¿å­˜çš„è®¾ç½®
             const savedSettings = localStorage.getItem('asrSettings');
             if (savedSettings) {
                 const settings = JSON.parse(savedSettings);
                 document.getElementById('normalizeAudio').checked = settings.normalizeAudio;
                 document.getElementById('removeSilence').checked = settings.removeSilence;
                 document.getElementById('enhanceVolume').checked = settings.enhanceVolume;
                 document.getElementById('compressAudio').checked = settings.compressAudio;
                 document.getElementById('targetSampleRate').value = settings.targetSampleRate;
                 
                 // æ›´æ–°ä¸»é¡µé¢checkboxçŠ¶æ€
                 const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                          settings.enhanceVolume || settings.compressAudio;
                 document.getElementById('enableASROptimization').checked = hasAnyOptimization;
             }

             // åŠ è½½æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–ä¿å­˜çš„è®¾ç½®
             const savedSpliceSettings = localStorage.getItem('spliceAsrSettings');
             if (savedSpliceSettings) {
                 const settings = JSON.parse(savedSpliceSettings);
                 document.getElementById('spliceNormalizeAudio').checked = settings.normalizeAudio;
                 document.getElementById('spliceRemoveSilence').checked = settings.removeSilence;
                 document.getElementById('spliceEnhanceVolume').checked = settings.enhanceVolume;
                 document.getElementById('spliceCompressAudio').checked = settings.compressAudio;
                 document.getElementById('spliceTargetSampleRate').value = settings.targetSampleRate;
                 
                 // æ›´æ–°ä¸»é¡µé¢checkboxçŠ¶æ€
                 const hasAnyOptimization = settings.normalizeAudio || settings.removeSilence || 
                                          settings.enhanceVolume || settings.compressAudio;
                 document.getElementById('enableSpliceASROptimization').checked = hasAnyOptimization;
             }
         });
     </script>

     <!-- ASRä¼˜åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
     <div id="asrOptimizationModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>ğŸ¯ ASRä¼˜åŒ–è®¾ç½®</h3>
                 <span class="modal-close" onclick="closeAsrModal()">&times;</span>
             </div>
             <div class="modal-body">
                 <div class="optimization-options">
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="normalizeAudio">
                             éŸ³é¢‘æ ‡å‡†åŒ–
                         </label>
                         <span class="option-desc">å¢å¼ºéŸ³é‡ï¼Œæé«˜ä¿¡å™ªæ¯”</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="removeSilence">
                             å»é™¤é™éŸ³æ®µ
                         </label>
                         <span class="option-desc">ç§»é™¤é•¿æ—¶é—´é™éŸ³ï¼Œæé«˜å¤„ç†æ•ˆç‡</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="enhanceVolume">
                             éŸ³é‡å¢å¼º
                         </label>
                         <span class="option-desc">è‡ªåŠ¨è°ƒæ•´éŸ³é‡åˆ°æœ€ä½³æ°´å¹³</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="compressAudio">
                             åŠ¨æ€èŒƒå›´å‹ç¼©
                         </label>
                         <span class="option-desc">å¹³è¡¡éŸ³é‡å·®å¼‚ï¼Œæ”¹å–„è¯†åˆ«æ•ˆæœ</span>
                     </div>
                     <div class="option-row">
                         <label>ç›®æ ‡é‡‡æ ·ç‡:</label>
                         <select id="targetSampleRate">
                             <option value="16000">16kHz (æ ‡å‡†)</option>
                             <option value="24000" selected>24kHz (æ¨è)</option>
                             <option value="48000">48kHz (é«˜è´¨é‡)</option>
                         </select>
                         <span class="option-desc">24kHzä¸ºASRæœ€ä½³é‡‡æ ·ç‡</span>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-success" onclick="applyAsrSettings()">åº”ç”¨è®¾ç½®</button>
                 <button class="btn" onclick="closeAsrModal()">å–æ¶ˆ</button>
             </div>
         </div>
     </div>

     <!-- æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
     <div id="spliceAsrOptimizationModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3>ğŸ¯ æ‹¼æ¥éŸ³é¢‘ASRä¼˜åŒ–è®¾ç½®</h3>
                 <span class="modal-close" onclick="closeSpliceAsrModal()">&times;</span>
             </div>
             <div class="modal-body">
                 <div class="optimization-options">
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceNormalizeAudio">
                             éŸ³é¢‘æ ‡å‡†åŒ–
                         </label>
                         <span class="option-desc">å¢å¼ºéŸ³é‡ï¼Œæé«˜ä¿¡å™ªæ¯”</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceRemoveSilence">
                             å»é™¤é™éŸ³æ®µ
                         </label>
                         <span class="option-desc">ç§»é™¤é•¿æ—¶é—´é™éŸ³ï¼Œæé«˜å¤„ç†æ•ˆç‡</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceEnhanceVolume">
                             éŸ³é‡å¢å¼º
                         </label>
                         <span class="option-desc">è‡ªåŠ¨è°ƒæ•´éŸ³é‡åˆ°æœ€ä½³æ°´å¹³</span>
                     </div>
                     <div class="option-row">
                         <label>
                             <input type="checkbox" id="spliceCompressAudio">
                             åŠ¨æ€èŒƒå›´å‹ç¼©
                         </label>
                         <span class="option-desc">å¹³è¡¡éŸ³é‡å·®å¼‚ï¼Œæ”¹å–„è¯†åˆ«æ•ˆæœ</span>
                     </div>
                     <div class="option-row">
                         <label>ç›®æ ‡é‡‡æ ·ç‡:</label>
                         <select id="spliceTargetSampleRate">
                             <option value="16000">16kHz (æ ‡å‡†)</option>
                             <option value="24000" selected>24kHz (æ¨è)</option>
                             <option value="48000">48kHz (é«˜è´¨é‡)</option>
                         </select>
                         <span class="option-desc">24kHzä¸ºASRæœ€ä½³é‡‡æ ·ç‡</span>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button class="btn btn-success" onclick="applySpliceAsrSettings()">åº”ç”¨è®¾ç½®</button>
                 <button class="btn" onclick="closeSpliceAsrModal()">å–æ¶ˆ</button>
             </div>
         </div>
     </div>

 </body>
 </html>
