<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®çºªè¦ç³»ç»Ÿ - ç»Ÿä¸€é—¨æˆ·ç³»ç»Ÿ</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 200px);
        }

        .card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 8px 12px;
            margin: -12px -12px 10px -12px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* éŸ³é¢‘ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            background-color: #fafafa;
            margin-bottom: 10px;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .upload-icon {
            font-size: 24px;
            color: #999;
            margin-bottom: 8px;
        }

        .upload-text {
            color: #666;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .file-info {
            color: #999;
            font-size: 9px;
        }

        .file-input {
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            display: none;
        }

        /* éŸ³é¢‘å¤„ç†åŒºåŸŸ */
        .processing-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group label {
            font-size: 11px;
            color: #333;
            min-width: 60px;
        }

        .option-group input, .option-group select {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }

        .audio-player {
            width: 100%;
            margin: 10px 0;
            height: 30px;
        }

        .progress-container {
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }

        /* ä¼šè®®çºªè¦ç”ŸæˆåŒºåŸŸ */
        .minutes-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .form-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row label {
            font-size: 11px;
            color: #333;
            min-width: 60px;
        }

        .form-row input {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }

        .result-area {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            min-height: 80px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            flex: 1;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .button-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-ready { background-color: #28a745; }
        .status-processing { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .container {
                margin: 5px;
            }
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ä¼šè®®çºªè¦ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆä¼šè®®çºªè¦ã€‚æ”¯æŒéŸ³é¢‘è£å‰ªã€å‹ç¼©ç­‰é¢„å¤„ç†åŠŸèƒ½ã€‚</p>
        </div>

        <div class="main-content">
            <!-- éŸ³é¢‘ä¸Šä¼ å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
                </div>
                <div class="card-content">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                        <div class="upload-icon">â˜ï¸</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                        <div class="file-info">
                            æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                            æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                        </div>
                    </div>
                    <input type="file" id="audioFile" class="file-input" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac,.wma">
                    <div id="uploadSuccess" class="success-message">
                        âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼
                    </div>
                    <div class="button-group">
                        <button class="btn" onclick="document.getElementById('audioFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                        <button class="btn btn-success" onclick="processUploadedFile()" id="processUploadBtn" disabled>å¤„ç†æ–‡ä»¶</button>
                        <button class="btn btn-warning" onclick="clearFile()">æ¸…é™¤æ–‡ä»¶</button>
                    </div>
                </div>
            </div>

            <!-- éŸ³é¢‘å¤„ç†å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    ğŸµ éŸ³é¢‘å¤„ç†
                </div>
                <div class="card-content">
                    <div class="processing-options">
                        <div class="option-group">
                            <label>å¼€å§‹æ—¶é—´:</label>
                            <input type="number" id="startTime" placeholder="ç§’" min="0" step="1">
                        </div>
                        <div class="option-group">
                            <label>ç»“æŸæ—¶é—´:</label>
                            <input type="number" id="endTime" placeholder="ç§’" min="0" step="1">
                        </div>
                        <div class="option-group">
                            <label>å‹ç¼©è´¨é‡:</label>
                            <select id="quality">
                                <option value="high">é«˜è´¨é‡</option>
                                <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                                <option value="low">ä½è´¨é‡</option>
                            </select>
                        </div>
                    </div>

                    <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>

                    <div class="progress-container" id="processProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="processAudio()" id="processBtn" disabled>
                            <span class="status-indicator status-ready"></span>å¤„ç†éŸ³é¢‘
                        </button>
                        <button class="btn" onclick="previewAudio()" id="previewBtn" disabled>é¢„è§ˆ</button>
                        <button class="btn btn-danger" onclick="stopProcessing()" id="stopBtn" disabled>åœæ­¢</button>
                    </div>
                </div>
            </div>

            <!-- ä¼šè®®çºªè¦ç”Ÿæˆå¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    ğŸ“ ä¼šè®®çºªè¦ç”Ÿæˆ
                </div>
                <div class="card-content">
                    <div class="minutes-form">
                        <div class="form-row">
                            <label>å‚ä¸äººæ•°:</label>
                            <input type="number" id="participantCount" placeholder="äººæ•°" min="1" max="50" value="5">
                        </div>
                        <div class="form-row">
                            <label>ä¼šè®®ä¸»é¢˜:</label>
                            <input type="text" id="meetingTopic" placeholder="è¯·è¾“å…¥ä¼šè®®ä¸»é¢˜">
                        </div>
                    </div>

                    <div class="result-area" id="minutesResult">
                        æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="generateMinutes()" id="generateBtn" disabled>
                            <span class="status-indicator status-ready"></span>ç”Ÿæˆä¼šè®®çºªè¦
                        </button>
                        <button class="btn" onclick="downloadMinutes()" id="downloadBtn" disabled>ä¸‹è½½çºªè¦</button>
                        <button class="btn btn-warning" onclick="clearMinutes()">æ¸…ç©ºç»“æœ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let processedAudioUrl = null;
        let isProcessing = false;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('audioFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            console.log('ä¼šè®®çºªè¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        function uploadFile(file) {
            console.log('uploadFile å‡½æ•°è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file);
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/aac', 'audio/ogg', 'audio/flac', 'audio/x-ms-wma'];
            if (!allowedTypes.includes(file.type)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ã€‚');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°è¶…è¿‡100MBé™åˆ¶ï¼');
                return;
            }

            // å­˜å‚¨æ–‡ä»¶
            uploadedFile = file;
            processedAudioUrl = URL.createObjectURL(file);

            // æ›´æ–°UIæ˜¾ç¤º
            const uploadArea = document.getElementById('uploadArea');
            const uploadSuccess = document.getElementById('uploadSuccess');
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <div class="upload-text">æ–‡ä»¶å·²é€‰æ‹©</div>
                <div class="file-info">
                    <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                    <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>ç±»å‹:</strong> ${file.type}
                </div>
            `;
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            uploadSuccess.style.display = 'block';
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('processUploadBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            
            // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.src = processedAudioUrl;
                audioPlayer.style.display = 'block';
            }

            console.log('æ–‡ä»¶é€‰æ‹©æˆåŠŸ:', file.name, 'å¤§å°:', file.size, 'ç±»å‹:', file.type);
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå®é™…ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
        async function processUploadedFile() {
            if (!uploadedFile) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            document.getElementById('processUploadBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');
            const originalText = resultArea.textContent;
            resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...';

            try {
                const formData = new FormData();
                formData.append('audio_file', uploadedFile);
                
                const response = await fetch('/meeting_minutes/upload_audio', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å¯ä»¥å¼€å§‹ç”Ÿæˆä¼šè®®çºªè¦æˆ–å¤„ç†éŸ³é¢‘ã€‚';
                document.getElementById('processBtn').disabled = false; // å¯ç”¨éŸ³é¢‘å¤„ç†æŒ‰é’®
                
                // å­˜å‚¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶IDï¼Œä¾›åç»­ä½¿ç”¨
                uploadedFile.dify_file_id = data.dify_file_id;
                uploadedFile.original_file_id = data.dify_file_id; // ç›´æ¥ä½¿ç”¨dify_file_idä½œä¸ºåŸå§‹æ–‡ä»¶ID
                
                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶ID:', data.dify_file_id);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                resultArea.textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message;
                document.getElementById('processUploadBtn').disabled = false;
            }
        }

        function clearFile() {
            uploadedFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('audioPlayer').style.display = 'none';
            document.getElementById('processUploadBtn').disabled = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
        }

        // éŸ³é¢‘å¤„ç†ç›¸å…³
        async function processAudio() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
            if (!uploadedFile.dify_file_id) {
                alert('è¯·å…ˆç‚¹å‡»"å¤„ç†æ–‡ä»¶"ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            isProcessing = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

            try {
                // è·å–å¤„ç†å‚æ•°
                const startTime = parseFloat(document.getElementById('startTime').value) || 0;
                const endTime = parseFloat(document.getElementById('endTime').value) || null;
                const quality = document.getElementById('quality').value;
                const compress = quality !== 'high'; // é«˜è´¨é‡ä¸å‹ç¼©ï¼Œä¸­ç­‰å’Œä½è´¨é‡å‹ç¼©

                // è°ƒç”¨åç«¯éŸ³é¢‘å¤„ç†API
                const response = await fetch('/meeting_minutes/process_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: uploadedFile.original_file_id || uploadedFile.name.split('.')[0],
                        start_time: startTime,
                        end_time: endTime,
                        compress: compress
                    })
                });

                if (!response.ok) {
                    throw new Error('éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³é¢‘å¤„ç†å¤±è´¥');
                }

                // å¤„ç†æˆåŠŸï¼Œä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶åˆ°Dify
                document.getElementById('progressText').textContent = 'æ­£åœ¨ä¸Šä¼ å¤„ç†åçš„éŸ³é¢‘...';
                
                const uploadResponse = await fetch('/meeting_minutes/upload_processed_audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processed_file_id: result.processed_file_id
                    })
                });

                if (!uploadResponse.ok) {
                    throw new Error('å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'å¤„ç†åéŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }

                // ä¿å­˜å¤„ç†åçš„æ–‡ä»¶ä¿¡æ¯
                uploadedFile.processed_file_id = uploadResult.dify_file_id;
                uploadedFile.processed_filename = uploadResult.filename;
                
                finishProcessing();
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                document.getElementById('progressText').textContent = 'å¤„ç†å¤±è´¥: ' + error.message;
                stopProcessing();
                alert('éŸ³é¢‘å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        function finishProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('progressText').textContent = 'å¤„ç†å®Œæˆï¼';
            
            setTimeout(() => {
                document.getElementById('processProgress').style.display = 'none';
            }, 2000);
            
            processedAudioUrl = document.getElementById('audioPlayer').src;
            console.log('éŸ³é¢‘å¤„ç†å®Œæˆ');
        }

        function previewAudio() {
            if (processedAudioUrl) {
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.currentTime = document.getElementById('startTime').value || 0;
                audioPlayer.play();
            }
        }

        function stopProcessing() {
            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('processProgress').style.display = 'none';
        }

        // ä¼šè®®çºªè¦ç”Ÿæˆç›¸å…³
        async function generateMinutes() {
            if (!uploadedFile) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶ï¼');
                return;
            }

            const participantCount = document.getElementById('participantCount').value;
            const meetingTopic = document.getElementById('meetingTopic').value;
            
            if (!participantCount) {
                alert('è¯·è¾“å…¥å‚ä¸äººæ•°ï¼');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            const resultArea = document.getElementById('minutesResult');

            try {
                let fileId;
                
                // ä¼˜å…ˆä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹æ–‡ä»¶ID
                if (uploadedFile.processed_file_id) {
                    fileId = uploadedFile.processed_file_id;
                    resultArea.textContent = 'ä½¿ç”¨å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶ID:', fileId);
                } else if (uploadedFile.dify_file_id) {
                    fileId = uploadedFile.dify_file_id;
                    resultArea.textContent = 'ä½¿ç”¨åŸå§‹éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆä¼šè®®çºªè¦...';
                    console.log('ä½¿ç”¨åŸå§‹æ–‡ä»¶ID:', fileId);
                } else {
                    // å¦‚æœæ–‡ä»¶è¿˜æ²¡ä¸Šä¼ ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
                    resultArea.textContent = 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶...';
                    
                    const formData = new FormData();
                    formData.append('audio_file', uploadedFile);
                    
                    const uploadResp = await fetch('/meeting_minutes/upload_audio', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResp.ok) {
                        throw new Error('éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                    }

                    const uploadData = await uploadResp.json();
                    if (!uploadData.success || !uploadData.dify_file_id) {
                        throw new Error('éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (uploadData.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                    
                    fileId = uploadData.dify_file_id;
                    uploadedFile.dify_file_id = fileId; // ä¿å­˜æ–‡ä»¶IDä¾›ä¸‹æ¬¡ä½¿ç”¨
                    resultArea.textContent = 'éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦...';
                }

                // 2. è°ƒç”¨ç”Ÿæˆä¼šè®®çºªè¦çš„API
                const generateResp = await fetch('/meeting_minutes/generate_minutes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: fileId,
                        participants_count: parseInt(participantCount),
                        additional_info: meetingTopic || ''
                    })
                });

                if (!generateResp.ok) {
                    throw new Error('ä¼šè®®çºªè¦ç”Ÿæˆæ¥å£è°ƒç”¨å¤±è´¥');
                }

                // 3. å¤„ç†æµå¼å“åº”
                const reader = generateResp.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let result = '';

                resultArea.textContent = 'æ­£åœ¨ç”Ÿæˆä¼šè®®çºªè¦ï¼Œè¯·ç¨å€™...';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split(/\n\n/);
                    buffer = lines.pop();

                    for (let line of lines) {
                        if (line.startsWith('data:')) {
                            let content = line.slice(5).trim();
                            if (content.startsWith('[ERROR]')) {
                                throw new Error(content);
                            } else {
                                try {
                                    let obj = JSON.parse(content);
                                    
                                    // å¤„ç†Difyå·¥ä½œæµçš„å“åº”
                                    if (obj.event === 'message' && obj.answer) {
                                        result += obj.answer;
                                        resultArea.textContent = result;
                                    } else if (obj.event === 'message_end') {
                                        // ç”Ÿæˆå®Œæˆ
                                        document.getElementById('downloadBtn').disabled = false;
                                        console.log('ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆ');
                                        break;
                                    } else if (obj.event === 'error') {
                                        throw new Error(obj.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æå¤±è´¥çš„ç‰‡æ®µï¼Œå¯èƒ½æ˜¯ä¸å®Œæ•´çš„JSON
                                    console.warn('JSONè§£æå¤±è´¥:', content);
                                }
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰è·å¾—ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤æ¶ˆæ¯
                if (!result.trim()) {
                    resultArea.textContent = 'ä¼šè®®çºªè¦ç”Ÿæˆå®Œæˆï¼Œä½†æœªè·å¾—æœ‰æ•ˆå†…å®¹ã€‚è¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶è´¨é‡æˆ–é‡è¯•ã€‚';
                }

            } catch (error) {
                console.error('ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥:', error);
                resultArea.textContent = 'ç”Ÿæˆä¼šè®®çºªè¦å¤±è´¥: ' + error.message;
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function downloadMinutes() {
            const content = document.getElementById('minutesResult').textContent;
            if (!content || content.includes('ç­‰å¾…éŸ³é¢‘å¤„ç†')) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¼šè®®çºªè¦ï¼');
                return;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¼šè®®çºªè¦_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearMinutes() {
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
        }

        function clearFile() {
            // é‡ç½®æ–‡ä»¶ç›¸å…³å˜é‡
            uploadedFile = null;
            processedAudioUrl = null;
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">â˜ï¸</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="file-info">
                    æ”¯æŒæ ¼å¼: .mp3, .wav, .m4a, .aac, .ogg, .flac, .wma<br>
                    æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                </div>
            `;
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('audioFile').value = '';
            
            // éšè—æˆåŠŸæ¶ˆæ¯
            document.getElementById('uploadSuccess').style.display = 'none';
            
            // ç¦ç”¨ç›¸å…³æŒ‰é’®
            document.getElementById('processUploadBtn').disabled = true;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            
            // éšè—éŸ³é¢‘æ’­æ”¾å™¨
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            
            // é‡ç½®ä¼šè®®çºªè¦ç»“æœ
            document.getElementById('minutesResult').textContent = 'æ–‡ä»¶ä¸Šä¼ åå³å¯ç”Ÿæˆä¼šè®®çºªè¦ï¼Œæ— éœ€ç­‰å¾…éŸ³é¢‘å¤„ç†å®Œæˆ...';
            document.getElementById('downloadBtn').disabled = true;
            
            console.log('æ–‡ä»¶å·²æ¸…é™¤');
        }
    </script>
</body>
</html>